<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - CEFR Test Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Nunito', sans-serif; }
        body { background-color: #0F172A; }

        :root {
            --primary: #FF6B6B;
            --secondary: #4ECDC4;
            --info: #45B7D1;
            --accent: #FFE66D;
            --purple: #A78BFA;
            --orange: #FF9F43;
            --bg: #0F172A;
            --card: #1E293B;
            --border: #334155;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #4ECDC4 0%, #45B7D1 100%);
            color: #0F172A;
            border-color: #4ECDC4;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .stat-card {
            background: linear-gradient(180deg, #1E293B 0%, #0F172A 100%);
            border: 2px solid #334155;
            border-radius: 16px;
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            border-color: #4ECDC4;
            transform: translateY(-2px);
        }

        .admin-card {
            background: #1E293B;
            border: 2px solid #334155;
            border-radius: 16px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4ECDC4 0%, #45B7D1 100%);
            color: #0F172A;
            font-weight: 700;
            padding: 10px 20px;
            border-radius: 12px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 0 #3da69f;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #3da69f;
        }
        .btn-primary:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #3da69f;
        }

        .btn-coral {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF9F43 100%);
            color: white;
            font-weight: 700;
            padding: 10px 20px;
            border-radius: 12px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 0 #cc5555;
        }
        .btn-coral:hover {
            transform: translateY(-2px);
        }
        .btn-coral:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #cc5555;
        }

        .form-input {
            background: #0F172A;
            border: 2px solid #334155;
            border-radius: 12px;
            color: white;
            padding: 12px 16px;
            width: 100%;
            transition: all 0.2s ease;
        }
        .form-input:focus {
            border-color: #4ECDC4;
            outline: none;
            box-shadow: 0 0 0 4px rgba(78, 205, 196, 0.15);
        }
        .form-input::placeholder {
            color: #64748b;
        }

        .question-card {
            background: #0F172A;
            border: 2px solid #334155;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .option-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .option-label {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #334155;
            border-radius: 8px;
            font-weight: 700;
            color: #94a3b8;
        }

        .correct-radio:checked + .option-label {
            background: linear-gradient(135deg, #4ECDC4 0%, #45B7D1 100%);
            color: #0F172A;
        }

        .modal-overlay {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(8px);
        }

        .logo-box {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF9F43 100%);
            box-shadow: 0 4px 0 #cc5555;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1E293B; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Wizard steps */
        .wizard-step {
            display: none;
        }
        .wizard-step.active {
            display: block;
        }
        .step-indicator {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            background: #334155;
            color: #64748b;
            transition: all 0.3s ease;
        }
        .step-indicator.active {
            background: linear-gradient(135deg, #4ECDC4 0%, #45B7D1 100%);
            color: #0F172A;
        }
        .step-indicator.completed {
            background: #4ECDC4;
            color: #0F172A;
        }
    </style>
</head>
<body class="min-h-screen text-white">

    <!-- Header -->
    <header class="border-b-2 border-[#334155] bg-[#1E293B]">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="/" class="flex items-center gap-3">
                    <div class="logo-box w-10 h-10 flex items-center justify-center text-white font-black text-lg rounded-xl">
                        C
                    </div>
                    <span class="text-xl font-black text-white">CEFR Test</span>
                </a>
                <div class="h-6 w-px bg-[#334155]"></div>
                <span class="px-3 py-1 bg-gradient-to-r from-[#A78BFA]/20 to-[#45B7D1]/20 text-[#A78BFA] text-xs font-bold rounded-full border border-[#A78BFA]/30">ADMIN</span>
            </div>
            <div class="flex items-center gap-4">
                <a href="/dashboard" class="text-gray-400 hover:text-[#4ECDC4] text-sm font-bold transition">Asosiy Sayt</a>
                <a href="/admin/logout" class="text-[#FF6B6B] hover:text-[#FF9F43] text-sm font-bold transition">Chiqish</a>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-8">
        <!-- Bizni natijalar: Foydalanuvchilar, Topshirilgan testlar, Like, Dislike -->
        <div class="grid md:grid-cols-4 gap-4 mb-8">
            <div class="stat-card p-5">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 bg-[#4ECDC4]/20 rounded-xl flex items-center justify-center">
                        <svg class="w-5 h-5 text-[#4ECDC4]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                        </svg>
                    </div>
                </div>
                <div class="text-3xl font-black text-[#4ECDC4]">{{ user_count }}</div>
                <div class="text-sm text-gray-400 font-bold mt-1">Foydalanuvchilar</div>
            </div>
            <div class="stat-card p-5">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 bg-[#45B7D1]/20 rounded-xl flex items-center justify-center">
                        <svg class="w-5 h-5 text-[#45B7D1]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                        </svg>
                    </div>
                </div>
                <div class="text-3xl font-black text-[#45B7D1]">{{ tests_taken }}</div>
                <div class="text-sm text-gray-400 font-bold mt-1">Topshirilgan testlar</div>
            </div>
            <div class="stat-card p-5">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 bg-[#58CC02]/20 rounded-xl flex items-center justify-center">
                        <svg class="w-5 h-5 text-[#58CC02]" fill="currentColor" viewBox="0 0 24 24"><path d="M1 21h4L9 5 21 3l-4 16H9l-8 2z"/></svg>
                    </div>
                </div>
                <div class="text-3xl font-black text-[#58CC02]">{{ likes_count }}</div>
                <div class="text-sm text-gray-400 font-bold mt-1">Like</div>
            </div>
            <div class="stat-card p-5">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 bg-[#FF6B6B]/20 rounded-xl flex items-center justify-center">
                        <svg class="w-5 h-5 text-[#FF6B6B]" fill="currentColor" viewBox="0 0 24 24"><path d="M19 15h-4V9h4V6l4 4-4 4v-3zm-5 4H2V3h12v2H4v12h10v2z"/></svg>
                    </div>
                </div>
                <div class="text-3xl font-black text-[#FF6B6B]">{{ dislikes_count }}</div>
                <div class="text-sm text-gray-400 font-bold mt-1">Dislike</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex flex-wrap gap-2 mb-6 border-b-2 border-[#334155] pb-4">
            <button class="tab-btn active px-5 py-2.5 border-2 border-[#334155] bg-[#1E293B] text-gray-300 font-bold text-sm rounded-xl transition" data-tab="reading">
                <span class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                    Reading
                </span>
            </button>
            <button class="tab-btn px-5 py-2.5 border-2 border-[#334155] bg-[#1E293B] text-gray-300 font-bold text-sm rounded-xl transition" data-tab="listening">
                <span class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/></svg>
                    Listening
                </span>
            </button>
            <button class="tab-btn px-5 py-2.5 border-2 border-[#334155] bg-[#1E293B] text-gray-300 font-bold text-sm rounded-xl transition" data-tab="writing">
                <span class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                    Writing
                </span>
            </button>
            <button class="tab-btn px-5 py-2.5 border-2 border-[#334155] bg-[#1E293B] text-gray-300 font-bold text-sm rounded-xl transition" data-tab="users">
                <span class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                    Foydalanuvchilar
                </span>
            </button>
            <button class="tab-btn px-5 py-2.5 border-2 border-[#334155] bg-[#1E293B] text-gray-300 font-bold text-sm rounded-xl transition" data-tab="feedback">
                <span class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
                    Feedbacklar
                </span>
            </button>
            <button class="tab-btn px-5 py-2.5 border-2 border-[#334155] bg-[#1E293B] text-gray-300 font-bold text-sm rounded-xl transition" data-tab="advanced">
                <span class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    Kengaytirilgan
                </span>
            </button>
        </div>

        <!-- Reading Tab -->
        <div id="reading-tab" class="tab-content active">
            <div class="admin-card p-6">
                <h2 class="text-xl font-black text-white flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 bg-[#A78BFA]/20 rounded-xl flex items-center justify-center">
                        <svg class="w-5 h-5 text-[#A78BFA]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                    </div>
                    Reading
                </h2>
                <div class="flex flex-wrap items-center gap-4 mb-6 p-4 bg-[#0F172A] rounded-xl border border-[#334155]">
                    <div><label class="text-xs text-gray-500 block mb-1">Test nomi</label><input type="text" id="reading-test-title" class="form-input w-48" placeholder="Reading Test 1"></div>
                    <div><label class="text-xs text-gray-500 block mb-1">Vaqt (daqiqa)</label><input type="number" id="reading-test-time" class="form-input w-24" value="60"></div>
                    <button type="button" onclick="saveSectionTestInfo('reading')" class="px-4 py-2 bg-[#A78BFA] hover:bg-[#9368E6] text-white font-bold rounded-xl text-sm">Testni saqlash</button>
                </div>

                <p class="text-sm font-bold text-gray-300 mb-3">Partni tanlang (1–5):</p>
                <div class="flex flex-wrap gap-3 mb-6">
                    <button type="button" onclick="selectPart('reading', 0)" id="reading-part-btn-0" class="part-btn px-5 py-3 rounded-xl font-bold border-2 border-[#334155] bg-[#1E293B] text-gray-400 hover:border-[#A78BFA] hover:text-[#A78BFA] transition" data-section="reading" data-part="0">Part 1</button>
                    <button type="button" onclick="selectPart('reading', 1)" id="reading-part-btn-1" class="part-btn px-5 py-3 rounded-xl font-bold border-2 border-[#334155] bg-[#1E293B] text-gray-400 hover:border-[#A78BFA] hover:text-[#A78BFA] transition" data-section="reading" data-part="1">Part 2</button>
                    <button type="button" onclick="selectPart('reading', 2)" id="reading-part-btn-2" class="part-btn px-5 py-3 rounded-xl font-bold border-2 border-[#334155] bg-[#1E293B] text-gray-400 hover:border-[#A78BFA] hover:text-[#A78BFA] transition" data-section="reading" data-part="2">Part 3</button>
                    <button type="button" onclick="selectPart('reading', 3)" id="reading-part-btn-3" class="part-btn px-5 py-3 rounded-xl font-bold border-2 border-[#334155] bg-[#1E293B] text-gray-400 hover:border-[#A78BFA] hover:text-[#A78BFA] transition" data-section="reading" data-part="3">Part 4</button>
                    <button type="button" onclick="selectPart('reading', 4)" id="reading-part-btn-4" class="part-btn px-5 py-3 rounded-xl font-bold border-2 border-[#334155] bg-[#1E293B] text-gray-400 hover:border-[#A78BFA] hover:text-[#A78BFA] transition" data-section="reading" data-part="4">Part 5</button>
                </div>

                <div id="reading-part-panel" class="hidden border-t-2 border-[#334155] pt-6">
                    <h3 class="text-lg font-bold text-white mb-3">Mavjud partlar</h3>
                    <div id="reading-mavjud-parts" class="space-y-3 mb-4"></div>
                    <button type="button" onclick="showNewPartForm('reading')" class="px-4 py-2 bg-[#58CC02] hover:bg-[#46A302] text-white font-bold rounded-xl text-sm mb-6">+ Yangi qo'shish</button>
                    <div id="reading-part-form-container" class="hidden"></div>
                    <div id="reading-part-save-wrap" class="hidden mt-4">
                        <button type="button" onclick="saveSectionPart('reading')" class="btn-primary">Partni saqlash</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Listening Tab -->
        <div id="listening-tab" class="tab-content">
            <div class="admin-card p-6">
                <h2 class="text-xl font-black text-white flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 bg-[#45B7D1]/20 rounded-xl flex items-center justify-center">
                        <svg class="w-5 h-5 text-[#45B7D1]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/></svg>
                    </div>
                    Listening
                </h2>
                <div class="flex flex-wrap items-center gap-4 mb-6 p-4 bg-[#0F172A] rounded-xl border border-[#334155]">
                    <div><label class="text-xs text-gray-500 block mb-1">Test nomi</label><input type="text" id="listening-test-title" class="form-input w-48" placeholder="Listening Test 1"></div>
                    <div><label class="text-xs text-gray-500 block mb-1">Vaqt (daqiqa)</label><input type="number" id="listening-test-time" class="form-input w-24" value="40"></div>
                    <button type="button" onclick="saveSectionTestInfo('listening')" class="px-4 py-2 bg-[#45B7D1] hover:bg-[#3AA3BB] text-white font-bold rounded-xl text-sm">Testni saqlash</button>
                </div>

                <p class="text-sm font-bold text-gray-300 mb-3">Partni tanlang (1–6):</p>
                <div class="flex flex-wrap gap-3 mb-6">
                    <button type="button" onclick="selectPart('listening', 0)" id="listening-part-btn-0" class="part-btn px-5 py-3 rounded-xl font-bold border-2 border-[#334155] bg-[#1E293B] text-gray-400 hover:border-[#45B7D1] hover:text-[#45B7D1] transition">Part 1</button>
                    <button type="button" onclick="selectPart('listening', 1)" id="listening-part-btn-1" class="part-btn px-5 py-3 rounded-xl font-bold border-2 border-[#334155] bg-[#1E293B] text-gray-400 hover:border-[#45B7D1] hover:text-[#45B7D1] transition">Part 2</button>
                    <button type="button" onclick="selectPart('listening', 2)" id="listening-part-btn-2" class="part-btn px-5 py-3 rounded-xl font-bold border-2 border-[#334155] bg-[#1E293B] text-gray-400 hover:border-[#45B7D1] hover:text-[#45B7D1] transition">Part 3</button>
                    <button type="button" onclick="selectPart('listening', 3)" id="listening-part-btn-3" class="part-btn px-5 py-3 rounded-xl font-bold border-2 border-[#334155] bg-[#1E293B] text-gray-400 hover:border-[#45B7D1] hover:text-[#45B7D1] transition">Part 4</button>
                    <button type="button" onclick="selectPart('listening', 4)" id="listening-part-btn-4" class="part-btn px-5 py-3 rounded-xl font-bold border-2 border-[#334155] bg-[#1E293B] text-gray-400 hover:border-[#45B7D1] hover:text-[#45B7D1] transition">Part 5</button>
                    <button type="button" onclick="selectPart('listening', 5)" id="listening-part-btn-5" class="part-btn px-5 py-3 rounded-xl font-bold border-2 border-[#334155] bg-[#1E293B] text-gray-400 hover:border-[#45B7D1] hover:text-[#45B7D1] transition">Part 6</button>
                </div>

                <div id="listening-part-panel" class="hidden border-t-2 border-[#334155] pt-6">
                    <h3 class="text-lg font-bold text-white mb-3">Mavjud partlar</h3>
                    <div id="listening-mavjud-parts" class="space-y-3 mb-4"></div>
                    <button type="button" onclick="showNewPartForm('listening')" class="px-4 py-2 bg-[#58CC02] hover:bg-[#46A302] text-white font-bold rounded-xl text-sm mb-6">+ Yangi qo'shish</button>
                    <div id="listening-part-form-container" class="hidden"></div>
                    <div id="listening-part-save-wrap" class="hidden mt-4">
                        <button type="button" onclick="saveSectionPart('listening')" class="btn-primary">Partni saqlash</button>
                    </div>
                </div>
                <div class="mt-6 pt-6 border-t-2 border-[#334155]">
                    <h3 class="text-lg font-bold text-white mb-2">Part 4: Xarita rasm yuklash</h3>
                    <div class="flex flex-wrap items-center gap-3">
                        <input type="file" id="listening-map-file" accept=".png,.jpg,.jpeg,.gif,.webp" class="text-sm text-gray-400 file:mr-3 file:py-2 file:px-4 file:rounded file:border-0 file:bg-[#45B7D1]/20 file:text-[#45B7D1] file:font-bold">
                        <button type="button" onclick="uploadListeningMap()" class="px-4 py-2 bg-[#45B7D1] hover:bg-[#3AA3BB] text-white font-bold rounded-lg text-sm transition">Yuklash</button>
                        <span id="listening-map-url" class="text-sm text-[#58CC02] break-all hidden"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Writing Tab -->
        <div id="writing-tab" class="tab-content">
            <div class="admin-card p-6">
                <h2 class="text-xl font-black text-white flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 bg-[#FF9F43]/20 rounded-xl flex items-center justify-center">
                        <svg class="w-5 h-5 text-[#FF9F43]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                    </div>
                    Writing
                </h2>
                <div class="flex flex-wrap items-center gap-4 mb-6 p-4 bg-[#0F172A] rounded-xl border border-[#334155]">
                    <div><label class="text-xs text-gray-500 block mb-1">Test nomi</label><input type="text" id="writing-test-title" class="form-input w-48" placeholder="Writing Test 1"></div>
                    <div><label class="text-xs text-gray-500 block mb-1">Vaqt (daqiqa)</label><input type="number" id="writing-test-time" class="form-input w-24" value="80"></div>
                    <button type="button" onclick="saveSectionTestInfo('writing')" class="px-4 py-2 bg-[#FF9F43] hover:bg-[#E68A33] text-white font-bold rounded-xl text-sm">Testni saqlash</button>
                </div>

                <p class="text-sm font-bold text-gray-300 mb-3">Partni tanlang (1–2):</p>
                <div class="flex flex-wrap gap-3 mb-6">
                    <button type="button" onclick="selectPart('writing', 0)" id="writing-part-btn-0" class="part-btn px-5 py-3 rounded-xl font-bold border-2 border-[#334155] bg-[#1E293B] text-gray-400 hover:border-[#FF9F43] hover:text-[#FF9F43] transition">Part 1</button>
                    <button type="button" onclick="selectPart('writing', 1)" id="writing-part-btn-1" class="part-btn px-5 py-3 rounded-xl font-bold border-2 border-[#334155] bg-[#1E293B] text-gray-400 hover:border-[#FF9F43] hover:text-[#FF9F43] transition">Part 2</button>
                </div>

                <div id="writing-part-panel" class="hidden border-t-2 border-[#334155] pt-6">
                    <h3 class="text-lg font-bold text-white mb-3">Mavjud partlar</h3>
                    <div id="writing-mavjud-parts" class="space-y-3 mb-4"></div>
                    <button type="button" onclick="showNewPartForm('writing')" class="px-4 py-2 bg-[#58CC02] hover:bg-[#46A302] text-white font-bold rounded-xl text-sm mb-6">+ Yangi qo'shish</button>
                    <div id="writing-part-form-container" class="hidden"></div>
                    <div id="writing-part-save-wrap" class="hidden mt-4">
                        <button type="button" onclick="saveSectionPart('writing')" class="btn-primary">Partni saqlash</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="users-tab" class="tab-content">
            <div class="admin-card p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-black text-white flex items-center gap-3">
                        <div class="w-10 h-10 bg-[#4ECDC4]/20 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-[#4ECDC4]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                        </div>
                        Foydalanuvchilar
                    </h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-[#0F172A] border-b-2 border-[#334155]">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-bold text-gray-400">Foydalanuvchi</th>
                                <th class="px-4 py-3 text-left text-sm font-bold text-gray-400">Email</th>
                                <th class="px-4 py-3 text-center text-sm font-bold text-gray-400">Bepul testlar</th>
                                <th class="px-4 py-3 text-center text-sm font-bold text-gray-400">Sotib olingan</th>
                                <th class="px-4 py-3 text-left text-sm font-bold text-gray-400">Ro'yxatdan o'tgan</th>
                                <th class="px-4 py-3 text-center text-sm font-bold text-gray-400">Amallar</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y-2 divide-[#334155]">
                            {% for user in users %}
                            <tr class="hover:bg-[#0F172A]/50 transition">
                                <td class="px-4 py-3">
                                    <div class="flex items-center gap-3">
                                        {% if user.picture %}
                                        <img src="{{ user.picture }}" class="w-10 h-10 rounded-xl" alt="">
                                        {% else %}
                                        <div class="w-10 h-10 bg-gradient-to-br from-[#4ECDC4] to-[#45B7D1] rounded-xl flex items-center justify-center text-white font-bold">
                                            {{ user.name[0] if user.name else 'U' }}
                                        </div>
                                        {% endif %}
                                        <span class="font-bold text-white">{{ user.name or 'Noma\'lum' }}</span>
                                    </div>
                                </td>
                                <td class="px-4 py-3 text-gray-400 font-medium">{{ user.email }}</td>
                                <td class="px-4 py-3 text-center">
                                    <span class="px-3 py-1 bg-[#4ECDC4]/20 text-[#4ECDC4] rounded-lg font-bold">{{ user.free_tests or 0 }}</span>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <span class="px-3 py-1 bg-[#FFE66D]/20 text-[#FFE66D] rounded-lg font-bold">{{ user.purchased_tests or 0 }}</span>
                                </td>
                                <td class="px-4 py-3 text-gray-500 text-sm font-medium">{{ user.created_at[:10] if user.created_at else '-' }}</td>
                                <td class="px-4 py-3 text-center">
                                    <button onclick="editUser('{{ user.id }}')" class="px-3 py-1 border-2 border-[#334155] text-gray-400 hover:text-[#4ECDC4] hover:border-[#4ECDC4] rounded-lg text-sm font-bold transition">Tahrirlash</button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="px-4 py-12 text-center text-gray-500 font-bold">Hozircha foydalanuvchilar yo'q</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Feedback Tab -->
        <div id="feedback-tab" class="tab-content">
            <div class="admin-card p-6">
                <h2 class="text-xl font-black text-white mb-6 flex items-center gap-3">
                    <div class="w-10 h-10 bg-[#FFE66D]/20 rounded-xl flex items-center justify-center">
                        <svg class="w-5 h-5 text-[#FFE66D]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
                    </div>
                    Foydalanuvchi Feedbacklari
                </h2>
                <div class="space-y-4">
                    {% for fb in feedbacks %}
                    <div class="bg-[#0F172A] border-2 border-[#334155] rounded-xl p-5">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-4">
                                {% if fb.rating %}
                                <div class="flex items-center gap-2 px-3 py-1.5 bg-[#4ECDC4]/20 rounded-lg">
                                    <svg class="w-4 h-4 text-[#4ECDC4]" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                                    <span class="text-[#4ECDC4] font-bold">{{ fb.rating }}/5</span>
                                </div>
                                {% endif %}
                                {% if fb.difficulty %}
                                <span class="px-3 py-1.5 bg-[#334155] text-gray-400 text-xs font-bold rounded-lg">{{ fb.difficulty }}</span>
                                {% endif %}
                                {% if fb.accuracy %}
                                <span class="px-3 py-1.5 bg-[#334155] text-gray-400 text-xs font-bold rounded-lg">{{ fb.accuracy }}</span>
                                {% endif %}
                            </div>
                            <span class="text-xs text-gray-600 font-bold">{{ fb.submitted_at[:10] if fb.submitted_at else '' }}</span>
                        </div>
                        {% if fb.best_part %}
                        <div class="mb-3 p-3 bg-[#4ECDC4]/10 border border-[#4ECDC4]/30 rounded-lg">
                            <span class="text-xs text-[#4ECDC4] uppercase font-bold block mb-1">Yaxshi:</span>
                            <p class="text-sm text-gray-300 font-medium">{{ fb.best_part }}</p>
                        </div>
                        {% endif %}
                        {% if fb.worst_part %}
                        <div class="mb-3 p-3 bg-[#FF6B6B]/10 border border-[#FF6B6B]/30 rounded-lg">
                            <span class="text-xs text-[#FF6B6B] uppercase font-bold block mb-1">Yaxshilash kerak:</span>
                            <p class="text-sm text-gray-300 font-medium">{{ fb.worst_part }}</p>
                        </div>
                        {% endif %}
                        {% if fb.suggestions %}
                        <div class="mb-3 p-3 bg-[#FFE66D]/10 border border-[#FFE66D]/30 rounded-lg">
                            <span class="text-xs text-[#FFE66D] uppercase font-bold block mb-1">Takliflar:</span>
                            <p class="text-sm text-gray-300 font-medium">{{ fb.suggestions }}</p>
                        </div>
                        {% endif %}
                        {% if fb.name or fb.email %}
                        <div class="mt-4 pt-4 border-t border-[#334155] text-xs text-gray-500 font-bold">
                            {% if fb.name %}{{ fb.name }}{% endif %}
                            {% if fb.email %} ({{ fb.email }}){% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="text-center py-12">
                        <div class="w-16 h-16 bg-[#334155] rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
                        </div>
                        <p class="text-gray-500 font-bold">Hozircha feedbacklar yo'q</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Advanced Tab (JSON Editor) -->
        <div id="advanced-tab" class="tab-content">
            <div class="admin-card p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-black text-white flex items-center gap-3">
                        <div class="w-10 h-10 bg-[#FF6B6B]/20 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-[#FF6B6B]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                        </div>
                        Kengaytirilgan Tahrirlash (JSON)
                    </h2>
                </div>
                <div class="bg-[#FF6B6B]/10 border-2 border-[#FF6B6B]/30 rounded-xl p-4 mb-6">
                    <p class="text-[#FF6B6B] text-sm font-bold flex items-center gap-2">
                        <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                        Diqqat! Bu bo'lim faqat tajribali foydalanuvchilar uchun. JSON formatida xato qilsangiz, ma'lumotlar buzilishi mumkin.
                    </p>
                </div>
                <div class="grid md:grid-cols-3 gap-4 mb-6">
                    <button onclick="loadJsonEditor('reading')" class="p-4 bg-[#0F172A] border-2 border-[#334155] rounded-xl hover:border-[#A78BFA] transition text-left">
                        <div class="w-10 h-10 bg-[#A78BFA]/20 rounded-xl flex items-center justify-center mb-3">
                            <svg class="w-5 h-5 text-[#A78BFA]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                        </div>
                        <h3 class="font-bold text-white">Reading Tests</h3>
                        <p class="text-xs text-gray-500 font-medium">JSON tahrirlash</p>
                    </button>
                    <button onclick="loadJsonEditor('listening')" class="p-4 bg-[#0F172A] border-2 border-[#334155] rounded-xl hover:border-[#45B7D1] transition text-left">
                        <div class="w-10 h-10 bg-[#45B7D1]/20 rounded-xl flex items-center justify-center mb-3">
                            <svg class="w-5 h-5 text-[#45B7D1]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/></svg>
                        </div>
                        <h3 class="font-bold text-white">Listening Tests</h3>
                        <p class="text-xs text-gray-500 font-medium">JSON tahrirlash</p>
                    </button>
                    <button onclick="loadJsonEditor('writing')" class="p-4 bg-[#0F172A] border-2 border-[#334155] rounded-xl hover:border-[#FF9F43] transition text-left">
                        <div class="w-10 h-10 bg-[#FF9F43]/20 rounded-xl flex items-center justify-center mb-3">
                            <svg class="w-5 h-5 text-[#FF9F43]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                        </div>
                        <h3 class="font-bold text-white">Writing Tests</h3>
                        <p class="text-xs text-gray-500 font-medium">JSON tahrirlash</p>
                    </button>
                </div>
                <div id="json-editor-container" class="hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h3 id="json-editor-title" class="text-lg font-bold text-white"></h3>
                        <button onclick="closeJsonEditor()" class="text-gray-400 hover:text-white">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                    <textarea id="json-editor" class="w-full h-96 bg-[#0F172A] border-2 border-[#334155] text-white p-4 font-mono text-sm rounded-xl focus:border-[#4ECDC4] outline-none"></textarea>
                    <div class="flex gap-4 mt-4">
                        <button onclick="saveJsonEditor()" class="btn-primary">Saqlash</button>
                        <button onclick="closeJsonEditor()" class="px-6 py-2 border-2 border-[#334155] text-gray-400 hover:border-[#4ECDC4] hover:text-[#4ECDC4] rounded-xl font-bold transition">Bekor qilish</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Part forma (sahifada ko'rsatiladi, modal emas) -->

    <!-- Part qo'shish modal (eski - kerak bo'lsa ishlatiladi) -->
    <div id="add-part-modal" class="fixed inset-0 modal-overlay flex items-center justify-center z-[60] hidden">
        <div class="bg-[#1E293B] border-2 border-[#334155] rounded-2xl p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
            <div class="flex items-center justify-between mb-4 flex-shrink-0">
                <h3 id="add-part-modal-title" class="text-lg font-black text-white">Part qo'shish</h3>
                <button type="button" onclick="closeAddPartModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="add-part-form-body" class="overflow-y-auto flex-1 min-h-0 space-y-4 pr-2"></div>
            <div class="flex gap-3 mt-4 pt-4 border-t border-[#334155] flex-shrink-0">
                <button type="button" onclick="submitPartForm()" class="btn-primary">Partni saqlash</button>
                <button type="button" onclick="closeAddPartModal()" class="px-4 py-2 border-2 border-[#334155] text-gray-400 hover:border-[#4ECDC4] hover:text-[#4ECDC4] rounded-xl font-bold text-sm">Bekor qilish</button>
            </div>
        </div>
    </div>

    <!-- User Edit Modal -->
    <div id="user-modal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
        <div class="bg-[#1E293B] border-2 border-[#334155] rounded-2xl p-6 max-w-md w-full mx-4">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-black text-white">Foydalanuvchini Tahrirlash</h3>
                <button onclick="closeUserModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>

            <form id="user-form">
                <input type="hidden" id="user-id" value="">

                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-300 mb-2">Bepul testlar soni</label>
                    <input type="number" id="user-free-tests" class="form-input" min="0" value="0">
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-bold text-gray-300 mb-2">Sotib olingan testlar soni</label>
                    <input type="number" id="user-purchased-tests" class="form-input" min="0" value="0">
                </div>

                <div class="flex gap-4">
                    <button type="submit" class="btn-primary">Saqlash</button>
                    <button type="button" onclick="closeUserModal()" class="px-6 py-2 border-2 border-[#334155] text-gray-400 hover:border-[#4ECDC4] hover:text-[#4ECDC4] rounded-xl font-bold transition">Bekor qilish</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentSection = null;
        let currentTests = [];
        let allUsers = {{ users | tojson | safe }};

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                const tab = this.dataset.tab;
                document.getElementById(tab + '-tab').classList.add('active');
                if (['reading','listening','writing'].includes(tab)) {
                    loadSectionData(tab);
                    document.getElementById(tab + '-part-panel').classList.add('hidden');
                    document.querySelectorAll('.part-btn').forEach(b => {
                        b.classList.remove('border-[#A78BFA]', 'border-[#45B7D1]', 'border-[#FF9F43]', 'text-[#A78BFA]', 'text-[#45B7D1]', 'text-[#FF9F43]', 'bg-[#A78BFA]/20', 'bg-[#45B7D1]/20', 'bg-[#FF9F43]/20');
                        b.classList.add('border-[#334155]', 'text-gray-400');
                    });
                    selectedPartTypeIndex = null;
                }
            });
        });
        loadSectionData('reading');

        let editingPartIndex = -1;
        let selectedPartTypeIndex = null;

        async function loadSectionData(section) {
            const tests = await loadTests(section);
            const test = tests[0];
            const titleEl = document.getElementById(section + '-test-title');
            const timeEl = document.getElementById(section + '-test-time');
            if (titleEl) titleEl.value = test ? test.title : '';
            if (timeEl) timeEl.value = test ? (test.time_limit != null ? test.time_limit : (section === 'reading' ? 60 : section === 'listening' ? 40 : 80)) : (section === 'reading' ? 60 : section === 'listening' ? 40 : 80);
        }

        function selectPart(section, typeIndex) {
            currentSection = section;
            currentPartTypeIndex = typeIndex;
            selectedPartTypeIndex = typeIndex;
            document.querySelectorAll('.part-btn').forEach(b => b.classList.remove('border-[#A78BFA]', 'border-[#45B7D1]', 'border-[#FF9F43]', 'text-[#A78BFA]', 'text-[#45B7D1]', 'text-[#FF9F43]', 'bg-[#A78BFA]/20', 'bg-[#45B7D1]/20', 'bg-[#FF9F43]/20'));
            const btn = document.getElementById(section + '-part-btn-' + typeIndex);
            if (btn) {
                btn.classList.remove('border-[#334155]', 'text-gray-400');
                if (section === 'reading') { btn.classList.add('border-[#A78BFA]', 'text-[#A78BFA]', 'bg-[#A78BFA]/20'); }
                else if (section === 'listening') { btn.classList.add('border-[#45B7D1]', 'text-[#45B7D1]', 'bg-[#45B7D1]/20'); }
                else { btn.classList.add('border-[#FF9F43]', 'text-[#FF9F43]', 'bg-[#FF9F43]/20'); }
            }
            const panel = document.getElementById(section + '-part-panel');
            panel.classList.remove('hidden');
            document.getElementById(section + '-part-form-container').classList.add('hidden');
            document.getElementById(section + '-part-form-container').innerHTML = '';
            document.getElementById(section + '-part-save-wrap').classList.add('hidden');
            refreshMavjudParts(section, typeIndex);
        }

        async function refreshMavjudParts(section, typeIndex) {
            const tests = await loadTests(section);
            const test = tests[0];
            const parts = test && test.parts ? test.parts : [];
            const pType = PART_TEMPLATES[section][typeIndex].type;
            const container = document.getElementById(section + '-mavjud-parts');
            const matching = parts.filter((p, i) => p.type === pType || (p.part_number === typeIndex + 1 && !p.type));
            if (matching.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Hozircha bu part yo\'q. «Yangi qo\'shish» bosing.</p>';
                return;
            }
            let html = '';
            matching.forEach((p, idx) => {
                const globalIndex = parts.indexOf(p);
                html += '<div class="p-4 bg-[#0F172A] rounded-xl border-2 border-[#334155] flex items-center justify-between gap-4">';
                html += '<div><span class="font-bold text-white">' + (p.title || 'Part ' + (typeIndex + 1)) + '</span></div>';
                html += '<div class="flex gap-2">';
                html += '<button type="button" onclick="editExistingPart(\'' + section + '\', ' + globalIndex + ')" class="px-4 py-2 bg-[#1CB0F6] hover:bg-[#1899D6] text-white font-bold rounded-lg text-sm">Tahrirlash</button>';
                html += '<button type="button" onclick="deleteExistingPart(\'' + section + '\', ' + globalIndex + ')" class="px-4 py-2 bg-[#FF4B4B] hover:bg-[#EA2B2B] text-white font-bold rounded-lg text-sm">O\'chirish</button>';
                html += '</div></div>';
            });
            container.innerHTML = html;
        }

        async function editExistingPart(section, partIndex) {
            const tests = await loadTests(section);
            const test = tests[0];
            if (!test || !test.parts || !test.parts[partIndex]) return;
            const partData = test.parts[partIndex];
            editingPartIndex = partIndex;
            currentSection = section;
            currentPartTypeIndex = selectedPartTypeIndex;
            const typeIndex = PART_TEMPLATES[section].findIndex(p => p.type === partData.type);
            if (typeIndex < 0) return;
            currentPartTypeIndex = typeIndex;
            const formContainer = document.getElementById(section + '-part-form-container');
            formContainer.innerHTML = renderPartForm(section, typeIndex, partData);
            formContainer.classList.remove('hidden');
            document.getElementById(section + '-part-save-wrap').classList.remove('hidden');
            setFormDataFromPart(section, typeIndex, partData);
            formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function showNewPartForm(section) {
            const typeIndex = selectedPartTypeIndex != null ? selectedPartTypeIndex : 0;
            currentSection = section;
            currentPartTypeIndex = typeIndex;
            editingPartIndex = -1;
            const formContainer = document.getElementById(section + '-part-form-container');
            formContainer.innerHTML = renderPartForm(section, typeIndex, null);
            formContainer.classList.remove('hidden');
            document.getElementById(section + '-part-save-wrap').classList.remove('hidden');
            formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        async function deleteExistingPart(section, partIndex) {
            if (!confirm('Bu partni o\'chirishni xohlaysizmi?')) return;
            const tests = await loadTests(section);
            const test = tests[0];
            if (!test || !test.parts) return;
            test.parts.splice(partIndex, 1);
            const res = await fetch('/admin/data/' + section, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ tests }) });
            if (res.ok) {
                alert('Part o\'chirildi');
                refreshMavjudParts(section, selectedPartTypeIndex);
                document.getElementById(section + '-part-form-container').classList.add('hidden');
                document.getElementById(section + '-part-save-wrap').classList.add('hidden');
            } else alert('Xatolik');
        }

        async function onSectionPartSelect(section) {
            const typeIndex = selectedPartTypeIndex != null ? selectedPartTypeIndex : 0;
            if (!PART_TEMPLATES[section] || !PART_TEMPLATES[section][typeIndex]) return;
            currentSection = section;
            currentPartTypeIndex = typeIndex;
            const tests = await loadTests(section);
            const test = tests[0];
            const parts = test && test.parts ? test.parts : [];
            const pType = PART_TEMPLATES[section][typeIndex].type;
            let partData = null;
            editingPartIndex = -1;
            for (let i = 0; i < parts.length; i++) {
                if (parts[i].type === pType || (parts[i].part_number === typeIndex + 1 && !parts[i].type)) {
                    partData = parts[i];
                    editingPartIndex = i;
                    break;
                }
            }
            const container = document.getElementById(section + '-part-form-container');
            container.innerHTML = renderPartForm(section, typeIndex, partData);
            container.classList.remove('hidden');
            document.getElementById(section + '-part-save-wrap').classList.remove('hidden');
            if (partData) setFormDataFromPart(section, typeIndex, partData);
        }

        function setFormDataFromPart(section, typeIndex, p) {
            const type = PART_TEMPLATES[section][typeIndex].type;
            function set(id, v) { const el = document.getElementById(id); if (el) el.value = v != null ? v : ''; }
            if (section === 'reading') {
                set('pf_title', p.title);
                set('pf_instruction', p.instruction);
                set('pf_text', p.text);
                if (type === 'open_cloze' && p.questions) p.questions.forEach((q, i) => set('pf_correct_' + (i+1), q.correct));
                if (type === 'multiple_choice_cloze' && p.questions) p.questions.forEach(q => {
                    set('pf_q' + q.number + '_question', q.question);
                    if (q.options) Object.keys(q.options).forEach(l => set('pf_q' + q.number + '_' + l, q.options[l]));
                    set('pf_q' + q.number + '_correct', q.correct);
                });
                if (type === 'matching_statements') {
                    if (p.descriptions) p.descriptions.forEach(desc => set('pf_desc_' + desc.number, desc.text));
                    if (p.statements) Object.keys(p.statements).forEach(l => set('pf_stmt_' + l, p.statements[l]));
                    if (p.questions) p.questions.forEach(q => set('pf_match_' + q.number, q.correct));
                }
                if (type === 'matching_headings') {
                    set('pf_main_title', p.main_title);
                    if (p.headings) Object.keys(p.headings).forEach(l => set('pf_heading_' + l, p.headings[l]));
                    if (p.paragraphs) p.paragraphs.forEach(para => set('pf_para_' + para.number, para.text));
                    if (p.questions) p.questions.forEach(q => set('pf_match_' + q.number, q.correct));
                }
                if (type === 'gapped_text') {
                    if (p.removed_sentences) Object.keys(p.removed_sentences).forEach(l => set('pf_sent_' + l, p.removed_sentences[l]));
                    if (p.questions) p.questions.forEach(q => set('pf_gap_' + q.number, q.correct));
                }
                if (type === 'multiple_choice_comprehension' && p.questions) p.questions.forEach(q => {
                    set('pf_cq' + q.number + '_q', q.question);
                    if (q.options && q.options.A !== 'True') Object.keys(q.options).forEach(l => set('pf_cq' + q.number + '_' + l, q.options[l]));
                    set('pf_cq' + q.number + '_correct', q.correct);
                });
                if (type === 'part5_mixed') {
                    if (p.gap_fill) {
                        set('pf_gap_text', p.gap_fill.text);
                        if (p.gap_fill.questions) p.gap_fill.questions.forEach(q => set('pf_gap_correct_' + q.number, q.correct));
                    }
                    if (p.questions) p.questions.forEach(q => {
                        set('pf_mcq' + q.number + '_q', q.question);
                        if (q.options) Object.keys(q.options).forEach(l => set('pf_mcq' + q.number + '_' + l, q.options[l]));
                        set('pf_mcq' + q.number + '_correct', q.correct);
                    });
                }
            }
            if (section === 'listening') {
                set('pf_title', p.title);
                set('pf_instruction', p.instruction);
                set('pf_audio_desc', p.audio_description);
                set('pf_transcript', p.transcript);
                set('pf_map_url', p.map_image_url);
                set('pf_text', p.text);
                if (type === 'short_conversations' && p.questions) p.questions.forEach(q => {
                    set('pf_sc' + q.number + '_desc', q.audio_description);
                    set('pf_sc' + q.number + '_transcript', q.transcript);
                    if (q.options) Object.keys(q.options).forEach(l => set('pf_sc' + q.number + '_' + l, q.options[l]));
                    set('pf_sc' + q.number + '_correct', q.correct);
                });
                if (type === 'sentence_completion' && p.questions) p.questions.forEach(q => { set('pf_sent_q' + q.number, q.question); set('pf_sent_correct_' + q.number, q.correct); });
                if (type === 'speaker_matching') {
                    if (p.speakers) p.speakers.forEach(s => { set('pf_spk_name_' + s.number, s.name); set('pf_spk_trans_' + s.number, s.transcript); });
                    if (p.options) Object.keys(p.options).forEach(l => set('pf_opt_' + l, p.options[l]));
                    if (p.answers) p.answers.forEach(a => set('pf_spk_correct_' + a.number, a.correct));
                }
                if (type === 'map_labeling' && p.places) p.places.forEach(pl => { set('pf_place_name_' + pl.number, pl.name); set('pf_place_correct_' + pl.number, pl.correct); });
                if (type === 'interview' && p.questions) p.questions.forEach(q => {
                    set('pf_intq' + q.number + '_q', q.question);
                    if (q.options) Object.keys(q.options).forEach(l => set('pf_intq' + q.number + '_' + l, q.options[l]));
                    set('pf_intq' + q.number + '_correct', q.correct);
                });
                if (type === 'note_completion' && p.questions) p.questions.forEach(q => set('pf_nc_correct_' + q.number, q.correct));
            }
            if (section === 'writing') {
                set('pf_title', p.title);
                set('pf_instruction', p.instruction);
                set('pf_prompt', p.prompt);
                set('pf_min_words', p.min_words);
                set('pf_max_words', p.max_words);
                if (p.tasks) p.tasks.forEach((t, i) => {
                    const n = i + 1;
                    set('pf_task' + n + '_title', t.title);
                    set('pf_task' + n + '_type', t.type);
                    set('pf_task' + n + '_instruction', t.instruction);
                    set('pf_task' + n + '_situation', t.situation);
                    set('pf_task' + n + '_min', t.min_words);
                    set('pf_task' + n + '_max', t.max_words);
                });
            }
        }

        async function saveSectionTestInfo(section) {
            const titleEl = document.getElementById(section + '-test-title');
            const timeEl = document.getElementById(section + '-test-time');
            const title = titleEl ? titleEl.value.trim() : '';
            const time = timeEl ? parseInt(timeEl.value, 10) : 60;
            const tests = await loadTests(section);
            let test = tests[0];
            if (!test) {
                test = { id: section + '_1', title: title || (section.charAt(0).toUpperCase() + section.slice(1) + ' Test 1'), time_limit: time, parts: [] };
                tests.unshift(test);
            } else {
                test.title = title || test.title;
                test.time_limit = time;
            }
            const res = await fetch('/admin/data/' + section, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ tests }) });
            if (res.ok) { alert('Test saqlandi'); loadSectionData(section); } else { alert('Xatolik'); }
        }

        async function saveSectionPart(section) {
            if (currentSection !== section || currentPartTypeIndex == null) return;
            const part = buildPartFromForm(section, currentPartTypeIndex);
            if (!part) return;
            const tests = await loadTests(section);
            let test = tests[0];
            if (!test) {
                const titleEl = document.getElementById(section + '-test-title');
                test = { id: section + '_1', title: titleEl ? titleEl.value.trim() || (section.charAt(0).toUpperCase() + section.slice(1) + ' Test 1') : 'Test 1', time_limit: parseInt(document.getElementById(section + '-test-time').value, 10) || 60, parts: [] };
                tests.unshift(test);
            }
            if (!test.parts) test.parts = [];
            if (section === 'writing') {
                part.part_number = currentPartTypeIndex === 0 ? 1 : 2;
            } else {
                part.part_number = editingPartIndex >= 0 ? test.parts[editingPartIndex].part_number : test.parts.length + 1;
            }
            if (editingPartIndex >= 0) test.parts[editingPartIndex] = part;
            else test.parts.push(part);
            const res = await fetch('/admin/data/' + section, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ tests }) });
            if (res.ok) {
                alert('Part saqlandi');
                loadSectionData(section);
                if (typeof refreshMavjudParts === 'function' && selectedPartTypeIndex != null) refreshMavjudParts(section, selectedPartTypeIndex);
            } else { alert('Xatolik: ' + (await res.text())); }
        }

        function buildPartFromForm(section, typeIndex) {
            const item = PART_TEMPLATES[section][typeIndex];
            const type = item.type;
            let part = { part_number: 1, title: getVal('pf_title') || item.label, instruction: getVal('pf_instruction') || '' };
            if (currentSection === 'reading') {
                if (type === 'open_cloze') {
                    part.type = 'open_cloze';
                    part.text = getVal('pf_text');
                    part.questions = [];
                    for (let i = 1; i <= 6; i++) part.questions.push({ number: i, correct: getVal('pf_correct_' + i) });
                } else if (type === 'matching_statements') {
                    part.type = 'matching_statements';
                    part.descriptions = [];
                    for (let i = 7; i <= 14; i++) {
                        part.descriptions.push({ number: i, text: getVal('pf_desc_' + i) });
                    }
                    part.statements = {};
                    ['A','B','C','D','E','F','G','H','I','J'].forEach(l => { part.statements[l] = getVal('pf_stmt_' + l); });
                    part.questions = [];
                    for (let i = 7; i <= 14; i++) {
                        part.questions.push({ number: i, correct: getVal('pf_match_' + i) });
                    }
                } else if (type === 'multiple_choice_cloze') {
                    part.type = 'multiple_choice_cloze';
                    part.text = getVal('pf_text');
                    part.questions = [];
                    for (let q = 0; q < 8; q++) {
                        const n = 9 + q;
                        const options = {};
                        ['A','B','C','D','E','F','G','H','I','J'].forEach(l => { options[l] = getVal('pf_q' + n + '_' + l); });
                        part.questions.push({ number: n, question: getVal('pf_q' + n + '_question'), options, correct: getVal('pf_q' + n + '_correct') });
                    }
                } else if (type === 'matching_headings') {
                    part.type = 'matching_headings';
                    part.main_title = getVal('pf_main_title');
                    part.headings = {};
                    ['A','B','C','D','E','F','G','H'].forEach(l => { part.headings[l] = getVal('pf_heading_' + l); });
                    part.paragraphs = [];
                    ['I','II','III','IV','V','VI'].forEach(pnum => {
                        part.paragraphs.push({ number: pnum, text: getVal('pf_para_' + pnum) });
                    });
                    part.questions = [];
                    const paraNums = ['I','II','III','IV','V','VI'];
                    const qNums = [15,16,17,18,19,20];
                    paraNums.forEach((pnum, idx) => {
                        const qnum = qNums[idx];
                        part.questions.push({ number: qnum, paragraph: pnum, correct: getVal('pf_match_' + qnum) });
                    });
                } else if (type === 'gapped_text') {
                    part.type = 'gapped_text';
                    part.text = getVal('pf_text');
                    part.removed_sentences = {};
                    ['A','B','C','D','E','F','G','H'].forEach(l => { part.removed_sentences[l] = getVal('pf_sent_' + l); });
                    part.questions = [];
                    for (let g = 0; g < 6; g++) part.questions.push({ number: 17 + g, correct: getVal('pf_gap_' + (17 + g)) });
                } else if (type === 'multiple_choice_comprehension') {
                    part.type = 'multiple_choice_comprehension';
                    part.text = getVal('pf_text');
                    part.questions = [];
                    for (let i = 0; i < 9; i++) {
                        const n = 23 + i;
                        const isTF = i >= 4;
                        if (isTF) part.questions.push({ number: n, question: getVal('pf_cq' + n + '_q'), options: { A: 'True', B: 'False', C: 'No information' }, correct: getVal('pf_cq' + n + '_correct') || 'A' });
                        else {
                            const options = {};
                            ['A','B','C','D'].forEach(l => { options[l] = getVal('pf_cq' + n + '_' + l); });
                            part.questions.push({ number: n, question: getVal('pf_cq' + n + '_q'), options, correct: getVal('pf_cq' + n + '_correct') });
                        }
                    }
                } else if (type === 'part5_mixed') {
                    part.type = 'part5_mixed';
                    part.text = getVal('pf_text');
                    part.gap_fill = { text: getVal('pf_gap_text'), questions: [] };
                    for (let i = 0; i < 4; i++) part.gap_fill.questions.push({ number: 32 + i, correct: getVal('pf_gap_correct_' + (32 + i)) });
                    part.questions = [];
                    for (let i = 0; i < 2; i++) {
                        const n = 36 + i;
                        const options = {};
                        ['A','B','C','D'].forEach(l => { options[l] = getVal('pf_mcq' + n + '_' + l); });
                        part.questions.push({ number: n, question: getVal('pf_mcq' + n + '_q'), options, correct: getVal('pf_mcq' + n + '_correct') });
                    }
                }
            }
            if (currentSection === 'listening') {
                if (type === 'short_conversations') {
                    part.type = 'short_conversations';
                    part.questions = [];
                    for (let i = 1; i <= 8; i++) {
                        const options = {};
                        ['A','B','C'].forEach(l => { options[l] = getVal('pf_sc' + i + '_' + l); });
                        part.questions.push({ number: i, audio_description: getVal('pf_sc' + i + '_desc'), transcript: getVal('pf_sc' + i + '_transcript'), options, correct: getVal('pf_sc' + i + '_correct') });
                    }
                } else if (type === 'sentence_completion') {
                    part.type = 'sentence_completion';
                    part.audio_description = getVal('pf_audio_desc');
                    part.transcript = getVal('pf_transcript');
                    part.questions = [];
                    for (let i = 0; i < 6; i++) part.questions.push({ number: 9 + i, question: getVal('pf_sent_q' + (9 + i)), correct: getVal('pf_sent_correct_' + (9 + i)) });
                } else if (type === 'speaker_matching') {
                    part.type = 'speaker_matching';
                    part.audio_description = getVal('pf_audio_desc');
                    part.speakers = [];
                    for (let i = 0; i < 4; i++) part.speakers.push({ number: 15 + i, name: getVal('pf_spk_name_' + (15 + i)), transcript: getVal('pf_spk_trans_' + (15 + i)) });
                    part.options = {};
                    ['A','B','C','D','E','F'].forEach(l => { part.options[l] = getVal('pf_opt_' + l); });
                    part.answers = [];
                    for (let i = 0; i < 4; i++) part.answers.push({ number: 15 + i, correct: getVal('pf_spk_correct_' + (15 + i)) });
                } else if (type === 'map_labeling') {
                    part.type = 'map_labeling';
                    part.map_image_url = getVal('pf_map_url');
                    part.audio_description = getVal('pf_audio_desc');
                    part.transcript = getVal('pf_transcript');
                    part.places = [];
                    part.map_labels = ['A','B','C','D','E','F','G','H'];
                    for (let i = 0; i < 5; i++) part.places.push({ number: 19 + i, name: getVal('pf_place_name_' + (19 + i)), correct: getVal('pf_place_correct_' + (19 + i)) });
                } else if (type === 'interview') {
                    part.type = 'interview';
                    part.audio_description = getVal('pf_audio_desc');
                    part.transcript = getVal('pf_transcript');
                    part.questions = [];
                    for (let i = 0; i < 6; i++) {
                        const n = 25 + i;
                        const options = {};
                        ['A','B','C'].forEach(l => { options[l] = getVal('pf_intq' + n + '_' + l); });
                        part.questions.push({ number: n, question: getVal('pf_intq' + n + '_q'), options, correct: getVal('pf_intq' + n + '_correct') });
                    }
                } else if (type === 'note_completion') {
                    part.type = 'note_completion';
                    part.audio_description = getVal('pf_audio_desc');
                    part.transcript = getVal('pf_transcript');
                    part.text = getVal('pf_text');
                    part.questions = [];
                    for (let i = 0; i < 6; i++) part.questions.push({ number: 31 + i, correct: getVal('pf_nc_correct_' + (31 + i)) });
                }
            }
            if (currentSection === 'writing') {
                if (type === 'tasks') {
                    part.type = 'tasks';
                    part.instruction = getVal('pf_instruction');
                    part.tasks = [];
                    for (let t = 1; t <= 2; t++) part.tasks.push({
                        task_number: t,
                        title: getVal('pf_task' + t + '_title'),
                        type: getVal('pf_task' + t + '_type') || ('task' + t),
                        instruction: getVal('pf_task' + t + '_instruction'),
                        situation: getVal('pf_task' + t + '_situation'),
                        min_words: parseInt(getVal('pf_task' + t + '_min') || 50, 10),
                        max_words: parseInt(getVal('pf_task' + t + '_max') || 500, 10)
                    });
                } else if (type === 'essay') {
                    part.type = 'essay';
                    part.prompt = getVal('pf_prompt');
                    part.min_words = parseInt(getVal('pf_min_words') || 180, 10);
                    part.max_words = parseInt(getVal('pf_max_words') || 200, 10);
                }
            }
            return part;
        }

        async function loadTests(section) {
            try {
                const response = await fetch(`/admin/data/${section}`);
                const data = await response.json();
                return data.tests || [];
            } catch (error) {
                console.error('Error loading tests:', error);
                return [];
            }
        }

        // Part templates for Reading, Listening, Writing
        const PART_TEMPLATES = {
            reading: [
                { label: 'Part 1: Open Cloze', type: 'open_cloze', template: { part_number: 1, title: 'Part 1: Open Cloze', instruction: 'For questions 1-6, read the text and write ONE word in each gap.', type: 'open_cloze', text: 'Matnni shu yerda yozing. Bo\'sh joylar: (1)_____, (2)_____, ...', questions: [ { number: 1, correct: '' }, { number: 2, correct: '' }, { number: 3, correct: '' }, { number: 4, correct: '' }, { number: 5, correct: '' }, { number: 6, correct: '' } ] }},
                { label: 'Part 2: Matching Statements', type: 'matching_statements', template: { part_number: 2, title: 'Part 2: Matching Statements', instruction: 'Read the texts 7-14 and the statements A-J. Decide which text matches with the situation described in the statements. Each statement can be used ONCE only. There are TWO extra statements which you do not need to use. Mark your answers on the answer sheet.', type: 'matching_statements', descriptions: [ { number: 7, text: '' }, { number: 8, text: '' }, { number: 9, text: '' }, { number: 10, text: '' }, { number: 11, text: '' }, { number: 12, text: '' }, { number: 13, text: '' }, { number: 14, text: '' } ], statements: { A: '', B: '', C: '', D: '', E: '', F: '', G: '', H: '', I: '', J: '' }, questions: [ { number: 7, correct: '' }, { number: 8, correct: '' }, { number: 9, correct: '' }, { number: 10, correct: '' }, { number: 11, correct: '' }, { number: 12, correct: '' }, { number: 13, correct: '' }, { number: 14, correct: '' } ] }},
                { label: 'Part 3: Matching Headings to Paragraphs', type: 'matching_headings', template: { part_number: 3, title: 'Part 3: Matching Headings to Paragraphs', instruction: 'Read the text and choose the correct heading for each paragraph from the list of headings below. There are more headings than paragraphs, so you will not use all of them. You cannot use any heading more than once.', type: 'matching_headings', main_title: '', headings: { A: '', B: '', C: '', D: '', E: '', F: '', G: '', H: '' }, paragraphs: [ { number: 'I', text: '' }, { number: 'II', text: '' }, { number: 'III', text: '' }, { number: 'IV', text: '' }, { number: 'V', text: '' }, { number: 'VI', text: '' } ], questions: [ { number: 15, paragraph: 'I', correct: '' }, { number: 16, paragraph: 'II', correct: '' }, { number: 17, paragraph: 'III', correct: '' }, { number: 18, paragraph: 'IV', correct: '' }, { number: 19, paragraph: 'V', correct: '' }, { number: 20, paragraph: 'VI', correct: '' } ] }},
                { label: 'Part 4: Reading Comprehension (MC + True/False)', type: 'multiple_choice_comprehension', template: { part_number: 1, title: 'Part 4: Reading Comprehension', instruction: 'Choose A–D for questions 23–26; True/False/No information for 27–31.', type: 'multiple_choice_comprehension', text: 'Maqola matni...', questions: [ { number: 23, question: '', options: { A: '', B: '', C: '', D: '' }, correct: '' } ] }},
                { label: 'Part 5: Mixed (4 bo\'sh joy + 2 savol)', type: 'part5_mixed', template: { part_number: 1, title: 'Part 5: Mixed', instruction: 'Complete gaps 32–35 with ONE word; answer 36–37 (A–D).', type: 'part5_mixed', text: 'Uzun matn...', gap_fill: { text: '(32)_____ (33)_____ (34)_____ (35)_____', questions: [ { number: 32, correct: '' }, { number: 33, correct: '' }, { number: 34, correct: '' }, { number: 35, correct: '' } ] }, questions: [ { number: 36, question: '', options: { A: '', B: '', C: '', D: '' }, correct: '' }, { number: 37, question: '', options: { A: '', B: '', C: '', D: '' }, correct: '' } ] }}
            ],
            listening: [
                { label: 'Part 1: Short Conversations (8 savol)', type: 'short_conversations', template: { part_number: 1, title: 'Part 1: Short Conversations', instruction: 'For questions 1-8, choose A, B or C.', type: 'short_conversations', questions: [ { number: 1, audio_description: '', transcript: '', options: { A: '', B: '', C: '' }, correct: '' } ] }},
                { label: 'Part 2: Sentence Completion (gap fill)', type: 'sentence_completion', template: { part_number: 1, title: 'Part 2: Sentence Completion', instruction: 'Complete sentences with ONE word.', type: 'sentence_completion', audio_description: '', transcript: '', questions: [ { number: 9, question: '_____', correct: '' } ] }},
                { label: 'Part 3: Speaker / Multiple Matching', type: 'speaker_matching', template: { part_number: 1, title: 'Part 3: Speaker Matching', instruction: 'Match each speaker with A–F.', type: 'speaker_matching', audio_description: '', speakers: [ { number: 15, name: 'Speaker 1', transcript: '' } ], options: { A: '', B: '', C: '', D: '', E: '', F: '' }, answers: [ { number: 15, correct: '' } ] }},
                { label: 'Part 4: Map Labeling', type: 'map_labeling', template: { part_number: 4, title: 'Part 4: Map Labeling', instruction: 'You will hear someone giving a talk. Label the places (19-23) on the map (A-H). There are THREE extra options which you do not need to use. Mark your answers on the answer sheet.', type: 'map_labeling', map_image_url: '', audio_description: '', transcript: '', places: [ { number: 19, name: '', correct: '' }, { number: 20, name: '', correct: '' }, { number: 21, name: '', correct: '' }, { number: 22, name: '', correct: '' }, { number: 23, name: '', correct: '' } ], map_labels: ['A','B','C','D','E','F','G','H'] }},
                { label: 'Part 5: Interview (Multiple Choice)', type: 'interview', template: { part_number: 1, title: 'Part 5: Interview', instruction: 'For questions 25-30, choose A, B or C.', type: 'interview', audio_description: '', transcript: '', questions: [ { number: 25, question: '', options: { A: '', B: '', C: '' }, correct: '' } ] }},
                { label: 'Part 6: Note Completion (bitta matn)', type: 'note_completion', template: { part_number: 1, title: 'Part 6: Note Completion', instruction: 'Complete notes with ONE word (31–36).', type: 'note_completion', audio_description: '', transcript: '', text: 'Matn (31)_____ (32)_____ ... (36)_____', questions: [ { number: 31, correct: '' }, { number: 32, correct: '' } ] }}
            ],
            writing: [
                { label: 'Part 1: Tasks (Task 1 va Task 2)', type: 'tasks', template: { part_number: 1, title: 'Part 1', instruction: 'Read the instructions for each task carefully. Complete Task 1 and Task 2.', tasks: [ { task_number: 1, title: 'Task 1', type: 'task1', instruction: '', situation: '', min_words: 50, max_words: 500 }, { task_number: 2, title: 'Task 2', type: 'task2', instruction: '', situation: '', min_words: 120, max_words: 150 } ] }},
                { label: 'Part 2: Essay', type: 'essay', template: { part_number: 1, title: 'Part 2: Essay', instruction: 'Write an essay.', type: 'essay', prompt: '', min_words: 180, max_words: 200 }}
            ]
        };

        function fillPartTypeSelect() {
            const sel = document.getElementById('part-type-select');
            sel.innerHTML = '<option value="">— Part turini tanlang —</option>';
            if (!currentSection || !PART_TEMPLATES[currentSection]) return;
            PART_TEMPLATES[currentSection].forEach((p, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = p.label;
                sel.appendChild(opt);
            });
        }

        function refreshPartsList() {
            const list = document.getElementById('parts-list');
            const raw = document.getElementById('test-parts-json').value.trim();
            list.innerHTML = '';
            try {
                const parts = raw ? JSON.parse(raw) : [];
                if (!Array.isArray(parts)) throw new Error('Massiv bo\'lishi kerak');
                parts.forEach((p, i) => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between py-2 px-3 bg-[#0F172A] border border-[#334155] rounded-lg';
                    div.innerHTML = '<span class="text-white font-medium text-sm">Part ' + (p.part_number || (i+1)) + ': ' + (p.title || p.type || '—') + '</span>' +
                        '<button type="button" onclick="deletePart(' + i + ')" class="text-[#FF6B6B] hover:bg-[#FF6B6B]/20 px-2 py-1 rounded text-xs font-bold">O\'chirish</button>';
                    list.appendChild(div);
                });
                if (parts.length === 0) list.innerHTML = '<p class="text-gray-500 text-sm">Hozircha qism yo\'q. Part qo\'shing yoki JSON kiriting.</p>';
            } catch (e) {
                list.innerHTML = '<p class="text-[#FF6B6B] text-sm">JSON xato: ' + e.message + '</p>';
            }
        }

        function deletePart(index) {
            try {
                const raw = document.getElementById('test-parts-json').value.trim();
                const parts = raw ? JSON.parse(raw) : [];
                if (!Array.isArray(parts) || index < 0 || index >= parts.length) return;
                parts.splice(index, 1);
                parts.forEach((p, i) => { p.part_number = i + 1; });
                document.getElementById('test-parts-json').value = JSON.stringify(parts, null, 2);
                refreshPartsList();
            } catch (e) { alert('Xatolik: ' + e.message); }
        }

        let currentPartTypeIndex = null;

        function openAddPartForm() {
            const sel = document.getElementById('part-type-select');
            const idx = sel.value;
            if (idx === '' || !currentSection || !PART_TEMPLATES[currentSection][parseInt(idx, 10)]) {
                alert('Avval Part turini tanlang');
                return;
            }
            currentPartTypeIndex = parseInt(idx, 10);
            const item = PART_TEMPLATES[currentSection][currentPartTypeIndex];
            document.getElementById('add-part-modal-title').textContent = 'Part qo\'shish: ' + item.label;
            document.getElementById('add-part-form-body').innerHTML = renderPartForm(currentSection, currentPartTypeIndex);
            document.getElementById('add-part-modal').classList.remove('hidden');
        }

        function closeAddPartModal() {
            document.getElementById('add-part-modal').classList.add('hidden');
            currentPartTypeIndex = null;
        }

        function renderPartForm(section, typeIndex, partData) {
            const item = PART_TEMPLATES[section][typeIndex];
            const type = item.type;
            const nextPartNum = (() => { try { const el = document.getElementById('test-parts-json'); const raw = el ? (el.value || '').trim() : ''; const p = raw ? JSON.parse(raw) : []; return (Array.isArray(p) && p.length) ? p.length + 1 : 1; } catch(e) { return 1; } })();
            const hasPart = partData && partData.questions && partData.questions.length > 0;

            if (section === 'reading') {
                if (type === 'open_cloze') {
                    let html = '<div class="space-y-4"><div><label class="block text-sm font-bold text-gray-300 mb-1">Part sarlavha</label><input type="text" id="pf_title" class="form-input" value="Part ' + nextPartNum + ': Open Cloze" placeholder="Part 1: Open Cloze"></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Ko\'rsatma</label><textarea id="pf_instruction" class="form-input h-16" placeholder="For questions 1-6...">For questions 1-6, read the text and write ONE word in each gap.</textarea></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Matn (bo\'sh joylar: (1)_____, (2)_____ ...)</label><textarea id="pf_text" class="form-input h-40 font-mono text-sm" placeholder="Climate change is (1)_____ most pressing..."></textarea></div>';
                    html += '<div class="border-t-2 border-[#334155] pt-4"><h3 class="text-lg font-bold text-white mb-3">Savollar (bo\'sh joylar uchun to\'g\'ri javoblar)</h3>';
                    html += '<div id="questions-list-open-cloze" class="space-y-2 mb-3"></div>';
                    html += '<div class="grid grid-cols-3 gap-2 mb-3">';
                    for (let i = 1; i <= 6; i++) html += '<div><label class="text-xs text-gray-500">' + i + '</label><input type="text" id="pf_correct_' + i + '" class="form-input py-1" placeholder="so\'z"></div>';
                    html += '</div>';
                    html += '<button type="button" onclick="addQuestionOpenCloze()" class="px-4 py-2 bg-[#58CC02] hover:bg-[#46A302] text-white font-bold rounded-lg text-sm">+ Savol qo\'shish</button>';
                    html += '</div></div>';
                    return html;
                }
                if (type === 'multiple_choice_cloze') {
                    const startNum = 9;
                    let html = '<div class="space-y-4"><div><label class="block text-sm font-bold text-gray-300 mb-1">Part sarlavha</label><input type="text" id="pf_title" class="form-input" value="Part ' + nextPartNum + ': Multiple Choice Cloze"></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Ko\'rsatma</label><textarea id="pf_instruction" class="form-input h-14">For questions ' + startNum + '-' + (startNum+7) + ', choose A–J for each gap.</textarea></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Matn (bo\'sh joylar: (' + startNum + ')_____ ...)</label><textarea id="pf_text" class="form-input h-32 font-mono text-sm"></textarea></div>';
                    html += '<div class="border-t-2 border-[#334155] pt-4"><h3 class="text-lg font-bold text-white mb-3">Savollar</h3>';
                    html += '<div id="questions-list-multiple-choice-cloze" class="space-y-2 mb-3"></div>';
                    for (let q = 0; q < 8; q++) {
                        const n = startNum + q;
                        html += '<div class="p-4 bg-[#0F172A] rounded-xl border border-[#334155] mb-2"><h4 class="font-bold text-[#4ECDC4] mb-2 text-sm">Savol ' + n + '</h4>';
                        html += '<input type="text" id="pf_q' + n + '_question" class="form-input mb-2 w-full" placeholder="Savol matni (jumla)">';
                        html += '<div class="grid grid-cols-5 gap-1 mb-2">';
                        ['A','B','C','D','E','F','G','H','I','J'].forEach((l, i) => { html += '<input type="text" id="pf_q' + n + '_' + l + '" class="form-input py-1 text-xs" placeholder="' + l + '">'; });
                        html += '</div><select id="pf_q' + n + '_correct" class="form-input py-1 w-20"><option value="">?</option>' + ['A','B','C','D','E','F','G','H','I','J'].map(l => '<option value="' + l + '">' + l + '</option>').join('') + '</select></div>';
                    }
                    html += '</div></div>';
                    return html;
                }
                if (type === 'matching_statements') {
                    let html = '<div class="space-y-4"><div><label class="block text-sm font-bold text-gray-300 mb-1">Part sarlavha</label><input type="text" id="pf_title" class="form-input" value="Part ' + nextPartNum + ': Matching Statements"></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Ko\'rsatma</label><textarea id="pf_instruction" class="form-input h-20">Read the texts 7-14 and the statements A-J. Decide which text matches with the situation described in the statements. Each statement can be used ONCE only. There are TWO extra statements which you do not need to use. Mark your answers on the answer sheet.</textarea></div>';
                    html += '<div class="border-t-2 border-[#334155] pt-4"><h3 class="text-lg font-bold text-white mb-3">Raqamli tavsiflar (7-14) — 8 ta</h3>';
                    for (let i = 7; i <= 14; i++) {
                        html += '<div class="mb-3 p-3 bg-[#0F172A] rounded-lg border border-[#334155]">';
                        html += '<label class="text-sm font-bold text-[#CE82FF] mb-2 block">' + i + '.</label>';
                        html += '<textarea id="pf_desc_' + i + '" class="form-input h-16" placeholder="Tavsif matni..."></textarea>';
                        html += '</div>';
                    }
                    html += '</div>';
                    html += '<div class="border-t-2 border-[#334155] pt-4"><h3 class="text-lg font-bold text-white mb-3">Harfli bayonotlar (A-J) — 10 ta</h3>';
                    ['A','B','C','D','E','F','G','H','I','J'].forEach(l => {
                        html += '<div class="mb-3 p-3 bg-[#0F172A] rounded-lg border border-[#334155]">';
                        html += '<label class="text-sm font-bold text-[#1CB0F6] mb-2 block">' + l + '.</label>';
                        html += '<textarea id="pf_stmt_' + l + '" class="form-input h-20" placeholder="Bayonot matni..."></textarea>';
                        html += '</div>';
                    });
                    html += '</div>';
                    html += '<div class="border-t-2 border-[#334155] pt-4"><h3 class="text-lg font-bold text-white mb-3">To\'g\'ri javoblar</h3>';
                    for (let i = 7; i <= 14; i++) {
                        html += '<div class="mb-2 flex items-center gap-3">';
                        html += '<span class="text-sm font-bold text-white w-8">' + i + ' =</span>';
                        html += '<select id="pf_match_' + i + '" class="form-input py-1 w-20"><option value="">?</option>' + ['A','B','C','D','E','F','G','H','I','J'].map(l => '<option value="' + l + '">' + l + '</option>').join('') + '</select>';
                        html += '</div>';
                    }
                    html += '</div></div>';
                    return html;
                }
                if (type === 'matching_headings') {
                    let html = '<div class="space-y-4"><div><label class="block text-sm font-bold text-gray-300 mb-1">Part sarlavha</label><input type="text" id="pf_title" class="form-input" value="Part ' + nextPartNum + ': Matching Headings to Paragraphs"></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Ko\'rsatma</label><textarea id="pf_instruction" class="form-input h-20">Read the text and choose the correct heading for each paragraph from the list of headings below. There are more headings than paragraphs, so you will not use all of them. You cannot use any heading more than once.</textarea></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Asosiy sarlavha (matn tepasida)</label><input type="text" id="pf_main_title" class="form-input" placeholder="HOW DOES THE BIOLOGICAL CLOCK TICK?"></div>';
                    html += '<div class="border-t-2 border-[#334155] pt-4"><h3 class="text-lg font-bold text-white mb-3">Headings (A–H) — 8 ta</h3>';
                    ['A','B','C','D','E','F','G','H'].forEach(l => {
                        html += '<div class="mb-2"><span class="text-[#FF9600] font-bold mr-2 w-6 inline-block">' + l + ')</span><input type="text" id="pf_heading_' + l + '" class="form-input flex-1 inline-block w-full md:w-auto" placeholder="Heading ' + l + '"></div>';
                    });
                    html += '</div>';
                    html += '<div class="border-t-2 border-[#334155] pt-4"><h3 class="text-lg font-bold text-white mb-3">Paragraflar (I–VI) — 6 ta</h3>';
                    ['I','II','III','IV','V','VI'].forEach((pnum, idx) => {
                        html += '<div class="mb-4 p-3 bg-[#0F172A] rounded-lg border border-[#334155]">';
                        html += '<label class="text-sm font-bold text-[#FF9600] mb-2 block">Paragraph ' + pnum + '</label>';
                        html += '<textarea id="pf_para_' + pnum + '" class="form-input h-32 font-mono text-sm" placeholder="Paragraph ' + pnum + ' matni..."></textarea>';
                        html += '</div>';
                    });
                    html += '</div>';
                    html += '<div class="border-t-2 border-[#334155] pt-4"><h3 class="text-lg font-bold text-white mb-3">To\'g\'ri javoblar (15–20)</h3>';
                    const paraNums = ['I','II','III','IV','V','VI'];
                    const qNums = [15,16,17,18,19,20];
                    paraNums.forEach((pnum, idx) => {
                        const qnum = qNums[idx];
                        html += '<div class="mb-2 flex items-center gap-3"><span class="text-sm text-gray-300 w-24">Question ' + qnum + ' (Para ' + pnum + '):</span>';
                        html += '<select id="pf_match_' + qnum + '" class="form-input py-1 w-32">';
                        html += '<option value="">— Tanlang —</option>';
                        ['A','B','C','D','E','F','G','H'].forEach(l => { html += '<option value="' + l + '">' + l + '</option>'; });
                        html += '</select></div>';
                    });
                    html += '</div></div>';
                    return html;
                }
                if (type === 'gapped_text') {
                    const startNum = 17;
                    let html = '<div class="space-y-4"><div><label class="block text-sm font-bold text-gray-300 mb-1">Part sarlavha</label><input type="text" id="pf_title" class="form-input" value="Part ' + nextPartNum + ': Gapped Text"></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Ko\'rsatma</label><textarea id="pf_instruction" class="form-input h-14">Choose A–H for each gap (' + startNum + '–' + (startNum+5) + '). Two extra sentences.</textarea></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Matn ((' + startNum + ')_____ ... (' + (startNum+5) + ')_____)</label><textarea id="pf_text" class="form-input h-40 font-mono text-sm"></textarea></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-2">Olib tashlangan jumlalar (A–H)</label>';
                    ['A','B','C','D','E','F','G','H'].forEach(l => { html += '<div class="mb-2"><span class="text-[#4ECDC4] font-bold mr-2">' + l + '.</span><input type="text" id="pf_sent_' + l + '" class="form-input flex-1 inline-block w-full" placeholder="Jumla ' + l + '"></div>'; });
                    html += '</div><div><label class="block text-sm font-bold text-gray-300 mb-2">To\'g\'ri javob (har bir bo\'sh joy uchun A–H)</label><div class="flex flex-wrap gap-2">';
                    for (let g = 0; g < 6; g++) html += '<div><label class="text-xs text-gray-500">Gap ' + (startNum+g) + '</label><select id="pf_gap_' + (startNum+g) + '" class="form-input py-1">' + ['A','B','C','D','E','F','G','H'].map(l => '<option value="' + l + '">' + l + '</option>').join('') + '</select></div>';
                    return html + '</div></div>';
                }
                if (type === 'multiple_choice_comprehension') {
                    let html = '<div class="space-y-4"><div><label class="block text-sm font-bold text-gray-300 mb-1">Part sarlavha</label><input type="text" id="pf_title" class="form-input" value="Part ' + nextPartNum + ': Reading Comprehension"></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Ko\'rsatma</label><textarea id="pf_instruction" class="form-input h-14">Read the article. Choose A–D or True/False/No information.</textarea></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Maqola matni</label><textarea id="pf_text" class="form-input h-48 font-mono text-sm"></textarea></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-2">Savollar (9 ta: 23–26 A–D, 27–31 True/False/No information)</label>';
                    const startQ = 23;
                    for (let i = 0; i < 9; i++) {
                        const n = startQ + i;
                        const isTF = i >= 4;
                        html += '<div class="p-3 bg-[#0F172A] rounded-lg mb-2"><label class="text-xs text-gray-500">Savol ' + n + '</label><input type="text" id="pf_cq' + n + '_q" class="form-input mb-2 w-full" placeholder="Savol matni">';
                        if (isTF) html += '<select id="pf_cq' + n + '_correct" class="form-input py-1"><option value="A">True</option><option value="B">False</option><option value="C">No information</option></select>';
                        else {
                            html += '<div class="grid grid-cols-4 gap-1 mb-1">';
                            ['A','B','C','D'].forEach(l => { html += '<input type="text" id="pf_cq' + n + '_' + l + '" class="form-input py-1 text-xs" placeholder="' + l + '">'; });
                            html += '</div><select id="pf_cq' + n + '_correct" class="form-input py-1"><option value="">?</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select>';
                        }
                        html += '</div>';
                    }
                    return html + '</div>';
                }
                if (type === 'part5_mixed') {
                    const base = 32;
                    let html = '<div class="space-y-4"><div><label class="block text-sm font-bold text-gray-300 mb-1">Part sarlavha</label><input type="text" id="pf_title" class="form-input" value="Part ' + nextPartNum + ': Mixed"></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Ko\'rsatma</label><textarea id="pf_instruction" class="form-input h-14">Complete gaps ' + base + '–' + (base+3) + ' with ONE word; answer ' + (base+4) + '–' + (base+5) + ' (A–D).</textarea></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Uzun matn (passage)</label><textarea id="pf_text" class="form-input h-32"></textarea></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Qisqa matn bo\'sh joylar bilan ((' + base + ')_____ ...)</label><textarea id="pf_gap_text" class="form-input h-20 font-mono text-sm"></textarea></div>';
                    html += '<div class="flex flex-wrap gap-2 mb-4">';
                    for (let i = 0; i < 4; i++) { const n = base + i; html += '<div><label class="text-xs text-gray-500">' + n + '</label><input type="text" id="pf_gap_correct_' + n + '" class="form-input py-1 w-24"></div>'; }
                    html += '</div><div><label class="block text-sm font-bold text-gray-300 mb-2">2 ta savol (A–D)</label>';
                    for (let i = 0; i < 2; i++) {
                        const n = base + 4 + i;
                        html += '<div class="p-3 bg-[#0F172A] rounded-lg mb-2"><input type="text" id="pf_mcq' + n + '_q" class="form-input mb-2" placeholder="Savol ' + n + '">';
                        html += '<div class="grid grid-cols-4 gap-1 mb-1">';
                        ['A','B','C','D'].forEach(l => { html += '<input type="text" id="pf_mcq' + n + '_' + l + '" class="form-input py-1 text-xs" placeholder="' + l + '">'; });
                        html += '</div><select id="pf_mcq' + n + '_correct" class="form-input py-1"><option value="">?</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select></div>';
                    }
                    return html + '</div>';
                }
            }

            if (section === 'listening') {
                if (type === 'short_conversations') {
                    let html = '<div class="space-y-4"><div><label class="block text-sm font-bold text-gray-300 mb-1">Part sarlavha</label><input type="text" id="pf_title" class="form-input" value="Part ' + nextPartNum + ': Short Conversations"></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Ko\'rsatma</label><textarea id="pf_instruction" class="form-input h-14">For questions 1-8, choose A, B or C.</textarea></div>';
                    for (let i = 1; i <= 8; i++) {
                        html += '<div class="p-4 bg-[#0F172A] rounded-xl border border-[#334155] mb-3"><h4 class="font-bold text-[#4ECDC4] mb-2 text-sm">Savol ' + i + '</h4>';
                        html += '<input type="text" id="pf_sc' + i + '_desc" class="form-input mb-2" placeholder="Audio tavsifi">';
                        html += '<textarea id="pf_sc' + i + '_transcript" class="form-input h-20 mb-2" placeholder="Transcript"></textarea>';
                        html += '<div class="grid grid-cols-3 gap-2 mb-2">';
                        ['A','B','C'].forEach(l => { html += '<input type="text" id="pf_sc' + i + '_' + l + '" class="form-input py-1" placeholder="' + l + '">'; });
                        html += '</div><select id="pf_sc' + i + '_correct" class="form-input py-1 w-20"><option value="">?</option><option value="A">A</option><option value="B">B</option><option value="C">C</option></select></div>';
                    }
                    return html + '</div>';
                }
                if (type === 'sentence_completion') {
                    const startNum = 9;
                    let html = '<div class="space-y-4"><div><label class="block text-sm font-bold text-gray-300 mb-1">Part sarlavha</label><input type="text" id="pf_title" class="form-input" value="Part ' + nextPartNum + ': Sentence Completion"></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Ko\'rsatma</label><textarea id="pf_instruction" class="form-input h-14">Complete sentences with ONE word (' + startNum + '–' + (startNum+5) + ').</textarea></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Audio tavsifi</label><input type="text" id="pf_audio_desc" class="form-input"></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Transcript</label><textarea id="pf_transcript" class="form-input h-24"></textarea></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-2">Savollar (jumla _____ bilan)</label>';
                    for (let i = 0; i < 6; i++) { const n = startNum + i; html += '<div class="mb-2"><label class="text-xs text-gray-500">' + n + '</label><input type="text" id="pf_sent_q' + n + '" class="form-input mb-1" placeholder="Jumla _____"><input type="text" id="pf_sent_correct_' + n + '" class="form-input py-1 w-32 inline-block" placeholder="To\'g\'ri javob"></div>'; }
                    return html + '</div></div>';
                }
                if (type === 'speaker_matching') {
                    const startNum = 15;
                    let html = '<div class="space-y-4"><div><label class="block text-sm font-bold text-gray-300 mb-1">Part sarlavha</label><input type="text" id="pf_title" class="form-input" value="Part ' + nextPartNum + ': Speaker Matching"></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Ko\'rsatma</label><textarea id="pf_instruction" class="form-input h-14">Match each speaker with A–F.</textarea></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Audio tavsifi</label><input type="text" id="pf_audio_desc" class="form-input"></div>';
                    for (let i = 0; i < 4; i++) { const n = startNum + i; html += '<div class="mb-3"><label class="text-xs text-gray-500">Spiker ' + n + '</label><input type="text" id="pf_spk_name_' + n + '" class="form-input mb-1" placeholder="Ism"><textarea id="pf_spk_trans_' + n + '" class="form-input h-16" placeholder="Transcript"></textarea></div>'; }
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-2">Variantlar A–F</label><div class="grid grid-cols-2 gap-2 mb-2">';
                    ['A','B','C','D','E','F'].forEach(l => { html += '<input type="text" id="pf_opt_' + l + '" class="form-input py-1" placeholder="' + l + '">'; });
                    html += '</div><label class="text-sm font-bold text-gray-300 mb-2">To\'g\'ri javob (har bir spiker)</label><div class="flex gap-2">';
                    for (let i = 0; i < 4; i++) { const n = startNum + i; html += '<div><label class="text-xs">' + n + '</label><select id="pf_spk_correct_' + n + '" class="form-input py-1">' + ['A','B','C','D','E','F'].map(l => '<option value="' + l + '">' + l + '</option>').join('') + '</select></div>'; }
                    return html + '</div></div>';
                }
                if (type === 'map_labeling') {
                    const startNum = 19;
                    let html = '<div class="space-y-4"><div><label class="block text-sm font-bold text-gray-300 mb-1">Part sarlavha</label><input type="text" id="pf_title" class="form-input" value="Part ' + nextPartNum + ': Map Labeling"></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Ko\'rsatma</label><textarea id="pf_instruction" class="form-input h-20">You will hear someone giving a talk. Label the places (19-23) on the map (A-H). There are THREE extra options which you do not need to use. Mark your answers on the answer sheet.</textarea></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Xarita rasm URL</label><input type="text" id="pf_map_url" class="form-input" placeholder="/static/uploads/listening_maps/..."></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Audio tavsifi</label><input type="text" id="pf_audio_desc" class="form-input"></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Transcript</label><textarea id="pf_transcript" class="form-input h-24"></textarea></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-2">Joylar (5 ta: 19-23, nom + harf A–H)</label>';
                    for (let i = 0; i < 5; i++) { const n = startNum + i; html += '<div class="flex gap-2 mb-2"><span class="text-gray-500 w-8">' + n + '</span><input type="text" id="pf_place_name_' + n + '" class="form-input flex-1" placeholder="Joy nomi"><select id="pf_place_correct_' + n + '" class="form-input py-1 w-20">' + ['A','B','C','D','E','F','G','H'].map(l => '<option value="' + l + '">' + l + '</option>').join('') + '</select></div>'; }
                    return html + '</div></div>';
                }
                if (type === 'interview') {
                    const startNum = 25;
                    let html = '<div class="space-y-4"><div><label class="block text-sm font-bold text-gray-300 mb-1">Part sarlavha</label><input type="text" id="pf_title" class="form-input" value="Part ' + nextPartNum + ': Interview"></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Ko\'rsatma</label><textarea id="pf_instruction" class="form-input h-14">For questions ' + startNum + '-' + (startNum+5) + ', choose A, B or C.</textarea></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Audio tavsifi</label><input type="text" id="pf_audio_desc" class="form-input"></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Transcript</label><textarea id="pf_transcript" class="form-input h-32"></textarea></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-2">Savollar (6 ta, A–B–C)</label>';
                    for (let i = 0; i < 6; i++) {
                        const n = startNum + i;
                        html += '<div class="p-3 bg-[#0F172A] rounded-lg mb-2"><input type="text" id="pf_intq' + n + '_q" class="form-input mb-2" placeholder="Savol ' + n + '"><div class="grid grid-cols-3 gap-2 mb-1">';
                        ['A','B','C'].forEach(l => { html += '<input type="text" id="pf_intq' + n + '_' + l + '" class="form-input py-1" placeholder="' + l + '">'; });
                        html += '</div><select id="pf_intq' + n + '_correct" class="form-input py-1"><option value="">?</option><option value="A">A</option><option value="B">B</option><option value="C">C</option></select></div>';
                    }
                    return html + '</div>';
                }
                if (type === 'note_completion') {
                    const startNum = 31;
                    let html = '<div class="space-y-4"><div><label class="block text-sm font-bold text-gray-300 mb-1">Part sarlavha</label><input type="text" id="pf_title" class="form-input" value="Part ' + nextPartNum + ': Note Completion"></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Ko\'rsatma</label><textarea id="pf_instruction" class="form-input h-14">Complete notes with ONE word (' + startNum + '–' + (startNum+5) + ').</textarea></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Audio tavsifi</label><input type="text" id="pf_audio_desc" class="form-input"></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Transcript (to\'liq)</label><textarea id="pf_transcript" class="form-input h-24"></textarea></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Matn bo\'sh joylar bilan ((' + startNum + ')_____ ...)</label><textarea id="pf_text" class="form-input h-32 font-mono text-sm"></textarea></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-2">To\'g\'ri javoblar (' + startNum + '–' + (startNum+5) + ')</label><div class="flex flex-wrap gap-2">';
                    for (let i = 0; i < 6; i++) { const n = startNum + i; html += '<div><label class="text-xs">' + n + '</label><input type="text" id="pf_nc_correct_' + n + '" class="form-input py-1 w-28"></div>'; }
                    return html + '</div></div>';
                }
            }

            if (section === 'writing') {
                if (type === 'tasks') {
                    let html = '<div class="space-y-4"><div><label class="block text-sm font-bold text-gray-300 mb-1">Part sarlavha</label><input type="text" id="pf_title" class="form-input" value="Part 1"></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Umumiy ko\'rsatma (Part 1 savoli)</label><textarea id="pf_instruction" class="form-input h-20">Read the instructions for each task carefully. Complete Task 1 and Task 2.</textarea></div>';
                    for (let t = 1; t <= 2; t++) {
                        html += '<div class="p-4 bg-[#0F172A] rounded-xl border border-[#334155]"><h4 class="font-bold text-[#4ECDC4] mb-2">Task ' + t + '</h4>';
html += '<input type="text" id="pf_task' + t + '_title" class="form-input mb-2" placeholder="Task sarlavha">';
                    html += '<input type="text" id="pf_task' + t + '_type" class="form-input mb-2" placeholder="Tur (ixtiyoriy)">';
                        html += '<textarea id="pf_task' + t + '_instruction" class="form-input h-16 mb-2" placeholder="Ko\'rsatma"></textarea>';
                        html += '<textarea id="pf_task' + t + '_situation" class="form-input h-24 mb-2" placeholder="Situation matni"></textarea>';
                        html += '<div class="flex gap-2"><input type="number" id="pf_task' + t + '_min" class="form-input w-24" placeholder="min so\'z" value="' + (t===1?50:120) + '"><input type="number" id="pf_task' + t + '_max" class="form-input w-24" placeholder="max" value="' + (t===1?500:150) + '"></div></div>';
                    }
                    return html + '</div>';
                }
                if (type === 'essay') {
                    let html = '<div class="space-y-4"><div><label class="block text-sm font-bold text-gray-300 mb-1">Part sarlavha</label><input type="text" id="pf_title" class="form-input" value="Part 2: Essay"></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Ko\'rsatma</label><textarea id="pf_instruction" class="form-input h-14">Write an essay.</textarea></div>';
                    html += '<div><label class="block text-sm font-bold text-gray-300 mb-1">Prompt (mavzu / savol)</label><textarea id="pf_prompt" class="form-input h-32"></textarea></div>';
                    html += '<div class="flex gap-4"><div><label class="text-sm font-bold text-gray-300 mb-1">Min so\'z</label><input type="number" id="pf_min_words" class="form-input w-24" value="180"></div><div><label class="text-sm font-bold text-gray-300 mb-1">Max so\'z</label><input type="number" id="pf_max_words" class="form-input w-24" value="200"></div></div>';
                    return html + '</div>';
                }
            }

            return '<p class="text-gray-500">Ushbu part turi uchun forma hozircha mavjud emas. Bo\'sh shablon tugmasidan foydalaning.</p>';
        }

        function renderQuestionsList(section, typeIndex, partData) {
            const type = PART_TEMPLATES[section][typeIndex].type;
            const containerId = 'questions-list-' + type.replace(/_/g, '-');
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (!partData || !partData.questions || partData.questions.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm py-2">Hozircha savollar yo\'q. Formani to\'ldiring va «Partni saqlash» bosing.</p>';
                return;
            }
            
            let html = '';
            partData.questions.forEach((q, idx) => {
                html += '<div class="p-3 bg-[#0F172A] rounded-lg border border-[#334155] mb-2" data-question-index="' + idx + '" data-question-number="' + (q.number || (idx + 1)) + '">';
                html += '<div class="flex items-start justify-between gap-3">';
                html += '<div class="flex-1">';
                html += '<div class="flex items-center gap-2 mb-1">';
                html += '<span class="w-6 h-6 bg-[#1CB0F6] rounded flex items-center justify-center text-white text-xs font-black">' + (q.number || (idx + 1)) + '</span>';
                
                if (type === 'open_cloze') {
                    html += '<span class="text-sm text-gray-300">To\'g\'ri javob: <strong class="text-[#58CC02]">' + (q.correct || '—') + '</strong></span>';
                } else if (type === 'multiple_choice_cloze') {
                    html += '<div class="flex-1"><span class="text-sm text-gray-300">' + (q.question || '—') + '</span>';
                    if (q.options) html += '<span class="text-xs text-gray-500 ml-2">(' + Object.keys(q.options).length + ' variant: ' + Object.keys(q.options).join(', ') + ')</span>';
                    html += '<span class="text-xs text-[#58CC02] font-bold ml-2">To\'g\'ri: ' + (q.correct || '?') + '</span></div>';
                } else if (type === 'multiple_choice_comprehension' || type === 'part5_mixed') {
                    html += '<div class="flex-1"><span class="text-sm text-gray-300">' + (q.question || '—') + '</span>';
                    if (q.options) {
                        const optKeys = Object.keys(q.options);
                        html += '<span class="text-xs text-gray-500 ml-2">(' + optKeys.length + ' variant';
                        if (q.options.A === 'True') html += ': True/False/No information';
                        else html += ': ' + optKeys.join(', ');
                        html += ')</span>';
                    }
                    html += '<span class="text-xs text-[#58CC02] font-bold ml-2">To\'g\'ri: ' + (q.correct || '?') + '</span></div>';
                } else if (type === 'gapped_text') {
                    html += '<span class="text-sm text-gray-300">Gap ' + (q.number || (idx + 1)) + ': <strong class="text-[#58CC02]">' + (q.correct || '—') + '</strong></span>';
                }
                
                html += '</div></div>';
                html += '</div>';
                html += '<div class="flex gap-2 flex-shrink-0">';
                html += '<button type="button" onclick="editQuestion(\'' + section + '\', ' + typeIndex + ', ' + idx + ')" class="px-3 py-1 bg-[#1CB0F6] hover:bg-[#1899D6] text-white text-xs font-bold rounded">Tahrirlash</button>';
                html += '<button type="button" onclick="deleteQuestion(\'' + section + '\', ' + typeIndex + ', ' + idx + ')" class="px-3 py-1 bg-[#FF4B4B] hover:bg-[#EA2B2B] text-white text-xs font-bold rounded">O\'chirish</button>';
                html += '</div></div></div>';
            });
            container.innerHTML = html;
        }

        async function editQuestion(section, typeIndex, questionIndex) {
            const tests = await loadTests(section);
            const test = tests[0];
            if (!test || !test.parts) return;
            const pType = PART_TEMPLATES[section][typeIndex].type;
            const part = test.parts.find(p => p.type === pType || (p.part_number === typeIndex + 1 && !p.type));
            if (!part || !part.questions || !part.questions[questionIndex]) return;
            
            const q = part.questions[questionIndex];
            const type = PART_TEMPLATES[section][typeIndex].type;
            
            // Formani to'ldirish
            if (type === 'open_cloze') {
                const inputId = 'pf_correct_' + (q.number || (questionIndex + 1));
                const input = document.getElementById(inputId);
                if (input) input.value = q.correct || '';
            } else if (type === 'multiple_choice_cloze') {
                const num = q.number || (questionIndex + 9);
                const qInput = document.getElementById('pf_q' + num + '_question');
                const correctSelect = document.getElementById('pf_q' + num + '_correct');
                if (qInput) qInput.value = q.question || '';
                if (correctSelect) correctSelect.value = q.correct || '';
                if (q.options) {
                    Object.keys(q.options).forEach(l => {
                        const optInput = document.getElementById('pf_q' + num + '_' + l);
                        if (optInput) optInput.value = q.options[l] || '';
                    });
                }
            } else if (type === 'multiple_choice_comprehension') {
                const num = q.number || (questionIndex + 23);
                const qInput = document.getElementById('pf_cq' + num + '_q');
                const correctSelect = document.getElementById('pf_cq' + num + '_correct');
                if (qInput) qInput.value = q.question || '';
                if (correctSelect) correctSelect.value = q.correct || '';
                if (q.options && q.options.A !== 'True') {
                    Object.keys(q.options).forEach(l => {
                        const optInput = document.getElementById('pf_cq' + num + '_' + l);
                        if (optInput) optInput.value = q.options[l] || '';
                    });
                }
            }
            
            // Scroll to form
            const container = document.getElementById(section + '-part-form-container');
            if (container) container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        async function deleteQuestion(section, typeIndex, questionIndex) {
            if (!confirm('Bu savolni o\'chirishni xohlaysizmi?')) return;
            
            const tests = await loadTests(section);
            const test = tests[0];
            if (!test || !test.parts) return;
            const pType = PART_TEMPLATES[section][typeIndex].type;
            const partIndex = test.parts.findIndex(p => p.type === pType || (p.part_number === typeIndex + 1 && !p.type));
            if (partIndex < 0) return;
            
            const part = test.parts[partIndex];
            if (!part.questions || !part.questions[questionIndex]) return;
            
            part.questions.splice(questionIndex, 1);
            // Renumber questions
            part.questions.forEach((q, i) => {
                if (!q.number) q.number = (typeIndex === 0 ? i + 1 : (typeIndex === 1 ? i + 9 : (typeIndex === 2 ? i + 17 : (typeIndex === 3 ? i + 23 : i + 32))));
            });
            
            const res = await fetch('/admin/data/' + section, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ tests }) });
            if (res.ok) {
                alert('Savol o\'chirildi');
                onSectionPartSelect(section);
            } else {
                alert('Xatolik');
            }
        }

        function addQuestionOpenCloze() {
            // Open cloze uchun yangi savol qo'shish - bu oddiy, faqat to'g'ri javob kiritiladi
            alert('Yangi savol qo\'shish uchun formani to\'ldiring va «Partni saqlash» bosing.');
        }

        function getVal(id) { const el = document.getElementById(id); return el ? (el.value || '').trim() : ''; }

        function submitPartForm() {
            if (currentSection == null || currentPartTypeIndex == null) return;
            const item = PART_TEMPLATES[currentSection][currentPartTypeIndex];
            const type = item.type;
            let part = { part_number: 1, title: getVal('pf_title') || item.label, instruction: getVal('pf_instruction') || '' };

            try {
                const parts = JSON.parse(document.getElementById('test-parts-json').value.trim() || '[]');
                part.part_number = parts.length + 1;
            } catch (e) {}

            if (currentSection === 'reading') {
                if (type === 'open_cloze') {
                    part.type = 'open_cloze';
                    part.text = getVal('pf_text');
                    part.questions = [];
                    for (let i = 1; i <= 6; i++) part.questions.push({ number: i, correct: getVal('pf_correct_' + i) });
                } else if (type === 'matching_statements') {
                    part.type = 'matching_statements';
                    part.descriptions = [];
                    for (let i = 7; i <= 14; i++) {
                        part.descriptions.push({ number: i, text: getVal('pf_desc_' + i) });
                    }
                    part.statements = {};
                    ['A','B','C','D','E','F','G','H','I','J'].forEach(l => { part.statements[l] = getVal('pf_stmt_' + l); });
                    part.questions = [];
                    for (let i = 7; i <= 14; i++) {
                        part.questions.push({ number: i, correct: getVal('pf_match_' + i) });
                    }
                } else if (type === 'multiple_choice_cloze') {
                    part.type = 'multiple_choice_cloze';
                    part.text = getVal('pf_text');
                    const startNum = 9;
                    part.questions = [];
                    for (let q = 0; q < 8; q++) {
                        const n = startNum + q;
                        const options = {};
                        ['A','B','C','D','E','F','G','H','I','J'].forEach(l => { options[l] = getVal('pf_q' + n + '_' + l); });
                        part.questions.push({ number: n, question: getVal('pf_q' + n + '_question'), options, correct: getVal('pf_q' + n + '_correct') });
                    }
                } else if (type === 'matching_headings') {
                    part.type = 'matching_headings';
                    part.main_title = getVal('pf_main_title');
                    part.headings = {};
                    ['A','B','C','D','E','F','G','H'].forEach(l => { part.headings[l] = getVal('pf_heading_' + l); });
                    part.paragraphs = [];
                    ['I','II','III','IV','V','VI'].forEach(pnum => {
                        part.paragraphs.push({ number: pnum, text: getVal('pf_para_' + pnum) });
                    });
                    part.questions = [];
                    const paraNums = ['I','II','III','IV','V','VI'];
                    const qNums = [15,16,17,18,19,20];
                    paraNums.forEach((pnum, idx) => {
                        const qnum = qNums[idx];
                        part.questions.push({ number: qnum, paragraph: pnum, correct: getVal('pf_match_' + qnum) });
                    });
                } else if (type === 'gapped_text') {
                    part.type = 'gapped_text';
                    part.text = getVal('pf_text');
                    part.removed_sentences = {};
                    ['A','B','C','D','E','F','G','H'].forEach(l => { part.removed_sentences[l] = getVal('pf_sent_' + l); });
                    const startNum = 17;
                    part.questions = [];
                    for (let g = 0; g < 6; g++) part.questions.push({ number: startNum + g, correct: getVal('pf_gap_' + (startNum + g)) });
                } else if (type === 'multiple_choice_comprehension') {
                    part.type = 'multiple_choice_comprehension';
                    part.text = getVal('pf_text');
                    const startQ = 23;
                    part.questions = [];
                    for (let i = 0; i < 9; i++) {
                        const n = startQ + i;
                        const isTF = i >= 4;
                        if (isTF) part.questions.push({ number: n, question: getVal('pf_cq' + n + '_q'), options: { A: 'True', B: 'False', C: 'No information' }, correct: getVal('pf_cq' + n + '_correct') || 'A' });
                        else {
                            const options = {};
                            ['A','B','C','D'].forEach(l => { options[l] = getVal('pf_cq' + n + '_' + l); });
                            part.questions.push({ number: n, question: getVal('pf_cq' + n + '_q'), options, correct: getVal('pf_cq' + n + '_correct') });
                        }
                    }
                } else if (type === 'part5_mixed') {
                    part.type = 'part5_mixed';
                    part.text = getVal('pf_text');
                    const base = 32;
                    part.gap_fill = { text: getVal('pf_gap_text'), questions: [] };
                    for (let i = 0; i < 4; i++) part.gap_fill.questions.push({ number: base + i, correct: getVal('pf_gap_correct_' + (base + i)) });
                    part.questions = [];
                    for (let i = 0; i < 2; i++) {
                        const n = base + 4 + i;
                        const options = {};
                        ['A','B','C','D'].forEach(l => { options[l] = getVal('pf_mcq' + n + '_' + l); });
                        part.questions.push({ number: n, question: getVal('pf_mcq' + n + '_q'), options, correct: getVal('pf_mcq' + n + '_correct') });
                    }
                }
            }

            if (currentSection === 'listening') {
                if (type === 'short_conversations') {
                    part.type = 'short_conversations';
                    part.questions = [];
                    for (let i = 1; i <= 8; i++) {
                        const options = {};
                        ['A','B','C'].forEach(l => { options[l] = getVal('pf_sc' + i + '_' + l); });
                        part.questions.push({ number: i, audio_description: getVal('pf_sc' + i + '_desc'), transcript: getVal('pf_sc' + i + '_transcript'), options, correct: getVal('pf_sc' + i + '_correct') });
                    }
                } else if (type === 'sentence_completion') {
                    part.type = 'sentence_completion';
                    part.audio_description = getVal('pf_audio_desc');
                    part.transcript = getVal('pf_transcript');
                    part.questions = [];
                    for (let i = 0; i < 6; i++) part.questions.push({ number: 9 + i, question: getVal('pf_sent_q' + (9 + i)), correct: getVal('pf_sent_correct_' + (9 + i)) });
                } else if (type === 'speaker_matching') {
                    part.type = 'speaker_matching';
                    part.audio_description = getVal('pf_audio_desc');
                    part.speakers = [];
                    for (let i = 0; i < 4; i++) part.speakers.push({ number: 15 + i, name: getVal('pf_spk_name_' + (15 + i)), transcript: getVal('pf_spk_trans_' + (15 + i)) });
                    part.options = {};
                    ['A','B','C','D','E','F'].forEach(l => { part.options[l] = getVal('pf_opt_' + l); });
                    part.answers = [];
                    for (let i = 0; i < 4; i++) part.answers.push({ number: 15 + i, correct: getVal('pf_spk_correct_' + (15 + i)) });
                } else if (type === 'map_labeling') {
                    part.type = 'map_labeling';
                    part.map_image_url = getVal('pf_map_url');
                    part.audio_description = getVal('pf_audio_desc');
                    part.transcript = getVal('pf_transcript');
                    part.places = [];
                    part.map_labels = ['A','B','C','D','E','F','G','H'];
                    for (let i = 0; i < 5; i++) part.places.push({ number: 19 + i, name: getVal('pf_place_name_' + (19 + i)), correct: getVal('pf_place_correct_' + (19 + i)) });
                } else if (type === 'interview') {
                    part.type = 'interview';
                    part.audio_description = getVal('pf_audio_desc');
                    part.transcript = getVal('pf_transcript');
                    part.questions = [];
                    for (let i = 0; i < 6; i++) {
                        const n = 25 + i;
                        const options = {};
                        ['A','B','C'].forEach(l => { options[l] = getVal('pf_intq' + n + '_' + l); });
                        part.questions.push({ number: n, question: getVal('pf_intq' + n + '_q'), options, correct: getVal('pf_intq' + n + '_correct') });
                    }
                } else if (type === 'note_completion') {
                    part.type = 'note_completion';
                    part.audio_description = getVal('pf_audio_desc');
                    part.transcript = getVal('pf_transcript');
                    part.text = getVal('pf_text');
                    part.questions = [];
                    for (let i = 0; i < 6; i++) part.questions.push({ number: 31 + i, correct: getVal('pf_nc_correct_' + (31 + i)) });
                }
            }

            if (currentSection === 'writing') {
                if (type === 'tasks') {
                    part.tasks = [];
                    for (let t = 1; t <= 2; t++) part.tasks.push({
                        task_number: t,
                        title: getVal('pf_task' + t + '_title'),
                        type: getVal('pf_task' + t + '_type') || ('task' + t),
                        instruction: getVal('pf_task' + t + '_instruction'),
                        situation: getVal('pf_task' + t + '_situation'),
                        min_words: parseInt(getVal('pf_task' + t + '_min') || 50, 10),
                        max_words: parseInt(getVal('pf_task' + t + '_max') || 500, 10)
                    });
                } else if (type === 'essay') {
                    part.type = 'essay';
                    part.prompt = getVal('pf_prompt');
                    part.min_words = parseInt(getVal('pf_min_words') || 180, 10);
                    part.max_words = parseInt(getVal('pf_max_words') || 200, 10);
                }
            }

            try {
                const raw = document.getElementById('test-parts-json').value.trim();
                const parts = raw ? JSON.parse(raw) : [];
                if (!Array.isArray(parts)) throw new Error('Massiv emas');
                parts.push(part);
                document.getElementById('test-parts-json').value = JSON.stringify(parts, null, 2);
                refreshPartsList();
                closeAddPartModal();
                document.getElementById('part-type-select').value = '';
            } catch (e) {
                alert('Saqlash xatosi: ' + e.message);
            }
        }

        function addPartFromTemplate() {
            const sel = document.getElementById('part-type-select');
            const idx = sel.value;
            if (idx === '' || !currentSection || !PART_TEMPLATES[currentSection][parseInt(idx, 10)]) {
                alert('Part turini tanlang');
                return;
            }
            const item = PART_TEMPLATES[currentSection][parseInt(idx, 10)];
            const template = JSON.parse(JSON.stringify(item.template));
            try {
                const raw = document.getElementById('test-parts-json').value.trim();
                const parts = raw ? JSON.parse(raw) : [];
                if (!Array.isArray(parts)) throw new Error('Parts massiv bo\'lishi kerak');
                template.part_number = parts.length + 1;
                parts.push(template);
                document.getElementById('test-parts-json').value = JSON.stringify(parts, null, 2);
                refreshPartsList();
                sel.value = '';
            } catch (e) { alert('JSON xato: ' + e.message); }
        }

        // Show Add Modal
        function showAddModal(section) {
            currentSection = section;
            document.getElementById('modal-title').textContent = section.charAt(0).toUpperCase() + section.slice(1) + ' - Yangi Test';
            document.getElementById('test-section').value = section;
            document.getElementById('test-id').value = '';
            document.getElementById('test-title').value = '';
            document.getElementById('test-time').value = '60';
            document.getElementById('test-parts-json').value = '[]';
            fillPartTypeSelect();
            refreshPartsList();
            document.getElementById('test-modal').classList.remove('hidden');
        }

        // Edit Test
        async function editTest(section, testId) {
            currentSection = section;
            currentTests = await loadTests(section);
            const test = currentTests.find(t => t.id === testId);
            if (test) {
                document.getElementById('modal-title').textContent = 'Test Tahrirlash: ' + test.title;
                document.getElementById('test-section').value = section;
                document.getElementById('test-id').value = testId;
                document.getElementById('test-title').value = test.title;
                document.getElementById('test-time').value = test.time_limit;
                document.getElementById('test-parts-json').value = JSON.stringify(test.parts || [], null, 2);
                fillPartTypeSelect();
                refreshPartsList();
                document.getElementById('test-modal').classList.remove('hidden');
            }
        }

        function closeTestModal() {
            document.getElementById('test-modal').classList.add('hidden');
        }

        document.getElementById('test-parts-json').addEventListener('blur', refreshPartsList);

        // Form submission
        document.getElementById('test-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const section = document.getElementById('test-section').value;
            const testId = document.getElementById('test-id').value;
            const title = document.getElementById('test-title').value;
            const timeLimit = parseInt(document.getElementById('test-time').value);
            const partsJson = document.getElementById('test-parts-json').value;

            let parts;
            try {
                parts = JSON.parse(partsJson);
            } catch (error) {
                alert('JSON format xato: ' + error.message);
                return;
            }

            currentTests = await loadTests(section);

            if (testId) {
                // Update existing
                const index = currentTests.findIndex(t => t.id === testId);
                if (index !== -1) {
                    currentTests[index].title = title;
                    currentTests[index].time_limit = timeLimit;
                    currentTests[index].parts = parts;
                }
            } else {
                // Add new
                const newTest = {
                    id: section + '_' + (currentTests.length + 1),
                    title: title,
                    time_limit: timeLimit,
                    parts: parts
                };
                currentTests.push(newTest);
            }

            const response = await fetch(`/admin/data/${section}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tests: currentTests })
            });

            if (response.ok) {
                alert('Saqlandi!');
                location.reload();
            } else {
                alert('Xatolik yuz berdi');
            }
        });

        async function uploadListeningMap() {
            const input = document.getElementById('listening-map-file');
            if (!input.files || !input.files[0]) {
                alert('Avval rasm faylini tanlang');
                return;
            }
            const form = new FormData();
            form.append('file', input.files[0]);
            const res = await fetch('/admin/upload-listening-map', { method: 'POST', body: form });
            const data = await res.json().catch(() => ({}));
            const urlEl = document.getElementById('listening-map-url');
            if (res.ok && data.url) {
                urlEl.textContent = 'URL: ' + data.url;
                urlEl.classList.remove('hidden');
                input.value = '';
            } else {
                urlEl.textContent = 'Xatolik: ' + (data.error || res.statusText);
                urlEl.classList.remove('hidden');
            }
        }

        async function deleteTest(section, testId) {
            if (!confirm('Rostdan o\'chirmoqchimisiz?')) return;

            currentTests = await loadTests(section);
            currentTests = currentTests.filter(t => t.id !== testId);

            const response = await fetch(`/admin/data/${section}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tests: currentTests })
            });

            if (response.ok) {
                location.reload();
            } else {
                alert('Xatolik yuz berdi');
            }
        }

        // User Modal
        function editUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (user) {
                document.getElementById('user-id').value = userId;
                document.getElementById('user-free-tests').value = user.free_tests || 0;
                document.getElementById('user-purchased-tests').value = user.purchased_tests || 0;
                document.getElementById('user-modal').classList.remove('hidden');
            }
        }

        function closeUserModal() {
            document.getElementById('user-modal').classList.add('hidden');
        }

        document.getElementById('user-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const userId = document.getElementById('user-id').value;
            const freeTests = parseInt(document.getElementById('user-free-tests').value);
            const purchasedTests = parseInt(document.getElementById('user-purchased-tests').value);

            const response = await fetch(`/admin/user/${userId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ free_tests: freeTests, purchased_tests: purchasedTests })
            });

            if (response.ok) {
                alert('Saqlandi!');
                location.reload();
            } else {
                alert('Xatolik yuz berdi');
            }
        });

        // JSON Editor (Advanced)
        let currentJsonSection = null;

        async function loadJsonEditor(section) {
            currentJsonSection = section;
            const tests = await loadTests(section);
            document.getElementById('json-editor-title').textContent = section.charAt(0).toUpperCase() + section.slice(1) + ' Tests JSON';
            document.getElementById('json-editor').value = JSON.stringify(tests, null, 2);
            document.getElementById('json-editor-container').classList.remove('hidden');
        }

        function closeJsonEditor() {
            document.getElementById('json-editor-container').classList.add('hidden');
            currentJsonSection = null;
        }

        async function saveJsonEditor() {
            try {
                const jsonText = document.getElementById('json-editor').value;
                const tests = JSON.parse(jsonText);

                const response = await fetch(`/admin/data/${currentJsonSection}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tests: tests })
                });

                if (response.ok) {
                    alert('Saqlandi!');
                    location.reload();
                } else {
                    alert('Xatolik yuz berdi');
                }
            } catch (error) {
                alert('JSON format xato: ' + error.message);
            }
        }
    </script>
</body>
</html>
