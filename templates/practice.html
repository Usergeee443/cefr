{% extends "base_app.html" %}
{% block title %}{% if lang == 'uz' %}Praktika{% else %}Practice{% endif %} - CEFR Test{% endblock %}

{% block head %}
<style>
    .practice-card {
        background: var(--bg-card);
        border: 2px solid var(--border-color);
        border-radius: 20px;
        transition: all 0.15s ease;
    }
    .practice-card:hover {
        border-color: var(--border-light);
        transform: translateY(-4px);
        box-shadow: 0 12px 30px rgba(0,0,0,0.3);
    }
    .skill-badge {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 800;
    }
    .level-a1 { background: var(--duo-green); color: white; box-shadow: 0 2px 0 var(--duo-green-dark); }
    .level-a2 { background: var(--duo-blue); color: white; box-shadow: 0 2px 0 var(--duo-blue-dark); }
    .level-b1 { background: var(--duo-yellow); color: #1A2C32; box-shadow: 0 2px 0 var(--duo-yellow-dark); }
    .level-b2 { background: var(--duo-orange); color: white; box-shadow: 0 2px 0 var(--duo-orange-dark); }
    .level-c1 { background: var(--duo-purple); color: white; box-shadow: 0 2px 0 var(--duo-purple-dark); }
    .level-c2 { background: var(--duo-red); color: white; box-shadow: 0 2px 0 var(--duo-red-dark); }

    .quiz-option {
        background: var(--bg-main);
        border: 2px solid var(--border-color);
        border-radius: 16px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.1s ease;
        font-weight: 700;
    }
    .quiz-option:hover {
        border-color: var(--duo-blue);
        background: rgba(28, 176, 246, 0.1);
        transform: translateY(-2px);
    }
    .quiz-option.correct {
        border-color: var(--duo-green);
        background: rgba(88, 204, 2, 0.15);
        box-shadow: 0 3px 0 var(--duo-green-dark);
        color: var(--duo-green);
    }
    .quiz-option.wrong {
        border-color: var(--duo-red);
        background: rgba(255, 75, 75, 0.15);
        box-shadow: 0 3px 0 var(--duo-red-dark);
        color: var(--duo-red);
    }

    .progress-ring { transform: rotate(-90deg); }
    .progress-ring-circle { transition: stroke-dashoffset 0.5s ease; }
</style>
{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 md:px-6 py-8 pb-24">
    <!-- Header -->
    <div class="mb-6 md:mb-8">
        <h1 class="text-3xl md:text-4xl font-black text-white mb-2 md:mb-3">
            &#128170; {% if lang == 'uz' %}Praktika{% else %}Practice{% endif %}
        </h1>
        <p class="text-[#AFAFAF] font-medium">{% if lang == 'uz' %}Ingliz tilingizni har kuni mashq qiling{% else %}Practice your English every day{% endif %}</p>
    </div>

    <!-- Daily Challenge Banner -->
    <div class="duo-card p-5 md:p-6 mb-6 md:mb-8" style="background: linear-gradient(135deg, var(--bg-card) 0%, #1E3A42 100%);">
        <div class="flex items-center justify-between flex-wrap gap-4">
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 md:w-16 md:h-16 bg-[#FF9600] rounded-2xl flex items-center justify-center text-2xl md:text-3xl" style="box-shadow: 0 4px 0 var(--duo-orange-dark);">
                    &#128293;
                </div>
                <div>
                    <h2 class="text-lg md:text-xl font-black text-white">{% if lang == 'uz' %}Kunlik mashq{% else %}Daily Challenge{% endif %}</h2>
                    <p class="text-[#AFAFAF] font-medium text-sm">{% if lang == 'uz' %}Bugun 5 ta mashqni bajaring{% else %}Complete 5 exercises today{% endif %}</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-center">
                    <div class="text-2xl md:text-3xl font-black text-[#FFC800]">3/5</div>
                    <div class="text-xs text-[#777] font-bold">{% if lang == 'uz' %}Bajarildi{% else %}Done{% endif %}</div>
                </div>
                <div class="w-14 h-14 md:w-16 md:h-16">
                    <svg class="progress-ring" width="64" height="64">
                        <circle stroke="var(--border-color)" stroke-width="6" fill="transparent" r="26" cx="32" cy="32"/>
                        <circle class="progress-ring-circle" stroke="#FFC800" stroke-width="6" fill="transparent" r="26" cx="32" cy="32"
                                stroke-dasharray="163.36" stroke-dashoffset="65.34" stroke-linecap="round"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Practice Categories -->
    <div class="grid grid-cols-2 lg:grid-cols-3 gap-3 md:gap-5 mb-6 md:mb-8">
        <!-- Vocabulary -->
        <div class="practice-card p-4 md:p-6">
            <div class="text-3xl md:text-4xl mb-3">&#128218;</div>
            <span class="skill-badge level-b1 mb-2 inline-block">B1-B2</span>
            <h3 class="text-base md:text-xl font-black text-white mb-1 md:mb-2">Vocabulary</h3>
            <p class="text-[#AFAFAF] text-xs md:text-sm font-medium mb-3 md:mb-4 hidden md:block">{% if lang == 'uz' %}So'z boyligini oshiring{% else %}Build your word power{% endif %}</p>
            <button onclick="startPractice('vocabulary')" class="btn-duo btn-duo-green w-full py-2 md:py-3 text-xs md:text-sm">{% if lang == 'uz' %}Boshlash{% else %}Start{% endif %}</button>
        </div>

        <!-- Grammar -->
        <div class="practice-card p-4 md:p-6">
            <div class="text-3xl md:text-4xl mb-3">&#127919;</div>
            <span class="skill-badge level-a2 mb-2 inline-block">A2-B1</span>
            <h3 class="text-base md:text-xl font-black text-white mb-1 md:mb-2">Grammar</h3>
            <p class="text-[#AFAFAF] text-xs md:text-sm font-medium mb-3 md:mb-4 hidden md:block">{% if lang == 'uz' %}Grammatika qoidalari{% else %}Master grammar rules{% endif %}</p>
            <button onclick="startPractice('grammar')" class="btn-duo btn-duo-blue w-full py-2 md:py-3 text-xs md:text-sm">{% if lang == 'uz' %}Boshlash{% else %}Start{% endif %}</button>
        </div>

        <!-- Reading -->
        <div class="practice-card p-4 md:p-6">
            <div class="text-3xl md:text-4xl mb-3">&#128214;</div>
            <span class="skill-badge level-b2 mb-2 inline-block">B1-C1</span>
            <h3 class="text-base md:text-xl font-black text-white mb-1 md:mb-2">Reading</h3>
            <p class="text-[#AFAFAF] text-xs md:text-sm font-medium mb-3 md:mb-4 hidden md:block">{% if lang == 'uz' %}O'qish ko'nikmalari{% else %}Improve reading{% endif %}</p>
            <button onclick="startPractice('reading')" class="btn-duo btn-duo-purple w-full py-2 md:py-3 text-xs md:text-sm">{% if lang == 'uz' %}Boshlash{% else %}Start{% endif %}</button>
        </div>

        <!-- Listening -->
        <div class="practice-card p-4 md:p-6">
            <div class="text-3xl md:text-4xl mb-3">&#127911;</div>
            <span class="skill-badge level-a2 mb-2 inline-block">A2-B2</span>
            <h3 class="text-base md:text-xl font-black text-white mb-1 md:mb-2">Listening</h3>
            <p class="text-[#AFAFAF] text-xs md:text-sm font-medium mb-3 md:mb-4 hidden md:block">{% if lang == 'uz' %}Eshitish qobiliyati{% else %}Listening skills{% endif %}</p>
            <button onclick="startPractice('listening')" class="btn-duo btn-duo-blue w-full py-2 md:py-3 text-xs md:text-sm">{% if lang == 'uz' %}Boshlash{% else %}Start{% endif %}</button>
        </div>

        <!-- Writing -->
        <div class="practice-card p-4 md:p-6">
            <div class="text-3xl md:text-4xl mb-3">&#9997;&#65039;</div>
            <span class="skill-badge level-b1 mb-2 inline-block">B1-C1</span>
            <h3 class="text-base md:text-xl font-black text-white mb-1 md:mb-2">Writing</h3>
            <p class="text-[#AFAFAF] text-xs md:text-sm font-medium mb-3 md:mb-4 hidden md:block">{% if lang == 'uz' %}Yozish malakasi{% else %}Writing skills{% endif %}</p>
            <button onclick="startPractice('writing')" class="btn-duo btn-duo-orange w-full py-2 md:py-3 text-xs md:text-sm">{% if lang == 'uz' %}Boshlash{% else %}Start{% endif %}</button>
        </div>

        <!-- Quick Quiz -->
        <div class="practice-card p-4 md:p-6 border-[#58CC02]/40">
            <div class="text-3xl md:text-4xl mb-3">&#9889;</div>
            <span class="px-3 py-1 bg-[#58CC02] text-white text-xs font-black rounded-full inline-block mb-2" style="box-shadow: 0 2px 0 #46A302;">NEW</span>
            <h3 class="text-base md:text-xl font-black text-white mb-1 md:mb-2">Quick Quiz</h3>
            <p class="text-[#AFAFAF] text-xs md:text-sm font-medium mb-3 md:mb-4 hidden md:block">{% if lang == 'uz' %}Tezkor test{% else %}Speed challenge{% endif %}</p>
            <button onclick="startQuickQuiz()" class="btn-duo btn-duo-green w-full py-2 md:py-3 text-xs md:text-sm">{% if lang == 'uz' %}Boshlash{% else %}Start{% endif %}</button>
        </div>
    </div>

    <!-- Quick Quiz Section (Initially Hidden) -->
    <div id="quiz-section" class="duo-card p-5 md:p-6 mb-6 md:mb-8 hidden">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg md:text-xl font-black text-white flex items-center gap-3">
                &#9889; Quick Quiz
            </h2>
            <div class="flex items-center gap-4">
                <div class="text-center">
                    <div id="quiz-score" class="text-xl md:text-2xl font-black text-[#58CC02]">0/0</div>
                    <div class="text-xs text-[#777] font-bold">Score</div>
                </div>
                <button onclick="closeQuiz()" class="text-[#AFAFAF] hover:text-white p-2 rounded-xl hover:bg-[#2B4148] transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>

        <div id="quiz-content"></div>

        <div id="quiz-result" class="hidden text-center py-6 md:py-8">
            <div class="text-6xl mb-4">&#127881;</div>
            <h3 class="text-2xl font-black text-white mb-2">{% if lang == 'uz' %}Ajoyib!{% else %}Great Job!{% endif %}</h3>
            <p id="quiz-final-score" class="text-[#AFAFAF] font-medium mb-6"></p>
            <button onclick="startQuickQuiz()" class="btn-duo btn-duo-green px-8 py-3">{% if lang == 'uz' %}Qayta boshlash{% else %}Try Again{% endif %}</button>
        </div>
    </div>

    <!-- Writing Practice Section -->
    <div id="writing-section" class="duo-card p-5 md:p-6 mb-6 md:mb-8 hidden">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg md:text-xl font-black text-white">&#9997;&#65039; {% if lang == 'uz' %}Yozish mashqi{% else %}Writing Practice{% endif %}</h2>
            <button onclick="closeWriting()" class="text-[#AFAFAF] hover:text-white p-2 rounded-xl hover:bg-[#2B4148] transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <div class="bg-[#131F24] border-2 border-[#2B4148] rounded-xl p-5 mb-6">
            <h3 class="font-bold text-[#FFC800] mb-2">{% if lang == 'uz' %}Topshiriq{% else %}Task{% endif %}:</h3>
            <p id="writing-prompt" class="text-[#AFAFAF] font-medium"></p>
            <div class="flex items-center gap-4 mt-4 text-sm text-[#777]">
                <span>&#128221; Min 80 {% if lang == 'uz' %}so'z{% else %}words{% endif %}</span>
                <span>&#9201;&#65039; 10 {% if lang == 'uz' %}daqiqa{% else %}min{% endif %}</span>
            </div>
        </div>

        <textarea id="writing-input" class="w-full h-48 bg-var(--bg-main) border-2 border-[#2B4148] rounded-xl p-4 text-white font-medium resize-none focus:border-[#58CC02] outline-none transition" style="background: var(--bg-main);" placeholder="{% if lang == 'uz' %}Bu yerga yozing...{% else %}Write here...{% endif %}"></textarea>

        <div class="flex items-center justify-between mt-4">
            <div id="word-count" class="text-[#777] font-bold">0 {% if lang == 'uz' %}so'z{% else %}words{% endif %}</div>
            <button onclick="submitWriting()" class="btn-duo btn-duo-green px-6 py-2 text-sm">{% if lang == 'uz' %}Yuborish{% else %}Submit{% endif %}</button>
        </div>

        <div id="writing-feedback" class="hidden mt-6 bg-[#58CC02]/10 border-2 border-[#58CC02]/30 rounded-xl p-5">
            <h4 class="font-bold text-[#58CC02] mb-2">{% if lang == 'uz' %}Natija{% else %}Feedback{% endif %}:</h4>
            <p id="writing-feedback-text" class="text-[#AFAFAF] font-medium"></p>
        </div>
    </div>

    <!-- Tips Section -->
    <div class="duo-card p-5 md:p-6">
        <h2 class="text-lg md:text-xl font-black text-white mb-5 md:mb-6">
            &#128161; {% if lang == 'uz' %}Foydali maslahatlar{% else %}Helpful Tips{% endif %}
        </h2>
        <div class="grid grid-cols-2 gap-3 md:gap-4">
            <div class="bg-[#1CB0F6]/10 border-2 border-[#1CB0F6]/30 rounded-xl p-3 md:p-4">
                <div class="text-2xl mb-2">&#128218;</div>
                <h4 class="font-bold text-[#1CB0F6] text-sm mb-1">Vocabulary</h4>
                <p class="text-[#AFAFAF] text-xs md:text-sm font-medium">{% if lang == 'uz' %}Har kuni 5-10 ta yangi so'z o'rganing{% else %}Learn 5-10 new words daily{% endif %}</p>
            </div>
            <div class="bg-[#CE82FF]/10 border-2 border-[#CE82FF]/30 rounded-xl p-3 md:p-4">
                <div class="text-2xl mb-2">&#127919;</div>
                <h4 class="font-bold text-[#CE82FF] text-sm mb-1">Grammar</h4>
                <p class="text-[#AFAFAF] text-xs md:text-sm font-medium">{% if lang == 'uz' %}Qoidalarni amalda qo'llang{% else %}Apply rules in practice{% endif %}</p>
            </div>
            <div class="bg-[#FF9600]/10 border-2 border-[#FF9600]/30 rounded-xl p-3 md:p-4">
                <div class="text-2xl mb-2">&#128214;</div>
                <h4 class="font-bold text-[#FF9600] text-sm mb-1">Reading</h4>
                <p class="text-[#AFAFAF] text-xs md:text-sm font-medium">{% if lang == 'uz' %}Inglizcha maqolalar o'qing{% else %}Read English articles{% endif %}</p>
            </div>
            <div class="bg-[#58CC02]/10 border-2 border-[#58CC02]/30 rounded-xl p-3 md:p-4">
                <div class="text-2xl mb-2">&#9997;&#65039;</div>
                <h4 class="font-bold text-[#58CC02] text-sm mb-1">Writing</h4>
                <p class="text-[#AFAFAF] text-xs md:text-sm font-medium">{% if lang == 'uz' %}Har kuni kamida 100 so'z yozing{% else %}Write 100+ words daily{% endif %}</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const quizQuestions = [
    {
        type: 'vocabulary',
        question: 'What is the synonym of "happy"?',
        options: ['Sad', 'Joyful', 'Angry', 'Tired'],
        correct: 1
    },
    {
        type: 'grammar',
        question: 'Choose the correct form: "She ___ to school every day."',
        options: ['go', 'goes', 'going', 'gone'],
        correct: 1
    },
    {
        type: 'vocabulary',
        question: 'What is the opposite of "expensive"?',
        options: ['Costly', 'Cheap', 'Rich', 'Poor'],
        correct: 1
    },
    {
        type: 'grammar',
        question: 'Which sentence is correct?',
        options: ['I have went there', 'I have gone there', 'I have go there', 'I has gone there'],
        correct: 1
    },
    {
        type: 'vocabulary',
        question: '"Necessary" means:',
        options: ['Optional', 'Required', 'Forbidden', 'Possible'],
        correct: 1
    },
    {
        type: 'grammar',
        question: 'Choose: "If I ___ rich, I would travel."',
        options: ['am', 'was', 'were', 'be'],
        correct: 2
    },
    {
        type: 'vocabulary',
        question: 'A "decade" is:',
        options: ['100 years', '10 years', '50 years', '1000 years'],
        correct: 1
    },
    {
        type: 'grammar',
        question: '"The book ___ by millions." (passive)',
        options: ['read', 'is reading', 'has been read', 'reads'],
        correct: 2
    },
    {
        type: 'vocabulary',
        question: '"Enormous" means:',
        options: ['Small', 'Medium', 'Very large', 'Normal'],
        correct: 2
    },
    {
        type: 'grammar',
        question: 'Correct: "Neither Tom ___ Jerry is here."',
        options: ['or', 'and', 'nor', 'but'],
        correct: 2
    }
];

const writingPrompts = [
    "Write an email to a friend inviting them to your birthday party. Include the date, time, location, and what activities you have planned.",
    "Describe your favorite place to visit. Explain why you like it and what activities you can do there.",
    "Write a review of a movie or book you recently enjoyed. Explain the plot briefly and give your opinion.",
    "Describe your typical daily routine. What time do you wake up, what do you do, and when do you go to sleep?",
    "Write about the advantages and disadvantages of social media for students.",
    "Describe your dream job. What would you do, why do you want it, and what skills do you need?"
];

let currentQuestion = 0;
let score = 0;
let shuffledQuestions = [];

function startQuickQuiz() {
    document.getElementById('quiz-section').classList.remove('hidden');
    document.getElementById('quiz-result').classList.add('hidden');
    document.getElementById('quiz-content').classList.remove('hidden');
    currentQuestion = 0;
    score = 0;
    shuffledQuestions = [...quizQuestions].sort(() => Math.random() - 0.5).slice(0, 5);
    showQuestion();
    // Scroll to quiz
    document.getElementById('quiz-section').scrollIntoView({ behavior: 'smooth' });
}

function showQuestion() {
    if (currentQuestion >= shuffledQuestions.length) {
        showResult();
        return;
    }

    const q = shuffledQuestions[currentQuestion];
    document.getElementById('quiz-score').textContent = `${score}/${currentQuestion}`;

    let html = `
        <div class="mb-4">
            <span class="px-3 py-1 bg-[#334155] text-gray-400 text-xs font-bold rounded-full">${currentQuestion + 1}/${shuffledQuestions.length}</span>
            <span class="ml-2 px-3 py-1 ${q.type === 'vocabulary' ? 'bg-[#4ECDC4]/20 text-[#4ECDC4]' : 'bg-[#A78BFA]/20 text-[#A78BFA]'} text-xs font-bold rounded-full">${q.type}</span>
        </div>
        <h3 class="text-lg font-bold text-white mb-6">${q.question}</h3>
        <div class="space-y-3">
    `;

    q.options.forEach((opt, idx) => {
        html += `<div class="quiz-option" onclick="selectAnswer(${idx})">${opt}</div>`;
    });

    html += '</div>';
    document.getElementById('quiz-content').innerHTML = html;
}

function selectAnswer(idx) {
    const q = shuffledQuestions[currentQuestion];
    const options = document.querySelectorAll('.quiz-option');

    options.forEach((opt, i) => {
        opt.onclick = null;
        if (i === q.correct) {
            opt.classList.add('correct');
        } else if (i === idx && idx !== q.correct) {
            opt.classList.add('wrong');
        }
    });

    if (idx === q.correct) {
        score++;
    }

    setTimeout(() => {
        currentQuestion++;
        showQuestion();
    }, 1000);
}

function showResult() {
    document.getElementById('quiz-content').classList.add('hidden');
    document.getElementById('quiz-result').classList.remove('hidden');
    document.getElementById('quiz-score').textContent = `${score}/${shuffledQuestions.length}`;
    const percentage = Math.round((score / shuffledQuestions.length) * 100);
    document.getElementById('quiz-final-score').textContent = `{% if lang == 'uz' %}Siz ${score}/${shuffledQuestions.length} to'g'ri javob berdingiz (${percentage}%){% else %}You got ${score}/${shuffledQuestions.length} correct (${percentage}%){% endif %}`.replace(/\$\{score\}/g, score).replace(/\$\{shuffledQuestions\.length\}/g, shuffledQuestions.length).replace(/\$\{percentage\}/g, percentage);
}

function closeQuiz() {
    document.getElementById('quiz-section').classList.add('hidden');
}

function startPractice(type) {
    if (type === 'writing') {
        document.getElementById('writing-section').classList.remove('hidden');
        const prompt = writingPrompts[Math.floor(Math.random() * writingPrompts.length)];
        document.getElementById('writing-prompt').textContent = prompt;
        document.getElementById('writing-input').value = '';
        document.getElementById('word-count').textContent = '0 {% if lang == "uz" %}so\'z{% else %}words{% endif %}';
        document.getElementById('writing-feedback').classList.add('hidden');
        document.getElementById('writing-section').scrollIntoView({ behavior: 'smooth' });
    } else {
        // For other types, start the quick quiz with filtered questions
        startQuickQuiz();
    }
}

function closeWriting() {
    document.getElementById('writing-section').classList.add('hidden');
}

// Word count
document.getElementById('writing-input').addEventListener('input', function() {
    const words = this.value.trim().split(/\s+/).filter(w => w.length > 0).length;
    document.getElementById('word-count').textContent = `${words} {% if lang == 'uz' %}so'z{% else %}words{% endif %}`;
});

function submitWriting() {
    const text = document.getElementById('writing-input').value.trim();
    const words = text.split(/\s+/).filter(w => w.length > 0).length;

    let feedback = '';
    if (words < 30) {
        feedback = "{% if lang == 'uz' %}Juda qisqa! Kamida 80 so'z yozing.{% else %}Too short! Write at least 80 words.{% endif %}";
    } else if (words < 80) {
        feedback = "{% if lang == 'uz' %}Yaxshi boshlanish! Yana bir oz yozing - 80 so'zga yetkazing.{% else %}Good start! Write a bit more - aim for 80 words.{% endif %}";
    } else if (words < 120) {
        feedback = "{% if lang == 'uz' %}Ajoyib! Siz 80 so'zdan oshib ketdingiz. Endi grammatika va so'z xilma-xilligiga e'tibor bering.{% else %}Great! You've exceeded 80 words. Now focus on grammar and vocabulary variety.{% endif %}";
    } else {
        feedback = "{% if lang == 'uz' %}Zo'r! Siz juda yaxshi yozdingiz. Davom eting!{% else %}Excellent! You've written a substantial piece. Keep it up!{% endif %}";
    }

    document.getElementById('writing-feedback').classList.remove('hidden');
    document.getElementById('writing-feedback-text').textContent = feedback;
}
</script>
{% endblock %}
