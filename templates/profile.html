{% extends "base_app.html" %}
{% block title %}{% if lang == 'uz' %}Profil{% else %}Profile{% endif %} - CEFR Level{% endblock %}

{% block head %}
<style>
    .profile-card {
        background: linear-gradient(180deg, #1f2937 0%, #111827 100%);
        border: 1px solid #374151;
    }
    .stats-card {
        background: linear-gradient(135deg, rgba(0, 212, 170, 0.08) 0%, rgba(0, 212, 170, 0.02) 100%);
        border: 1px solid rgba(0, 212, 170, 0.2);
    }
    .history-row {
        transition: all 0.2s ease;
    }
    .history-row:hover {
        background: rgba(0, 212, 170, 0.05);
    }
    .cefr-badge {
        background: linear-gradient(135deg, #00D4AA 0%, #00B894 100%);
        color: #0d0d0d;
    }
    .section-header {
        background: linear-gradient(90deg, rgba(0, 212, 170, 0.1) 0%, transparent 100%);
    }
    .contact-card {
        background: linear-gradient(180deg, #1f2937 0%, #111827 100%);
        border: 1px solid #374151;
        transition: all 0.2s ease;
    }
    .contact-card:hover {
        border-color: #00D4AA;
    }
    .feedback-input {
        background: #0d1117;
        border: 1px solid #374151;
        transition: all 0.2s ease;
    }
    .feedback-input:focus {
        border-color: #00D4AA;
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 md:px-6 py-8 md:py-12 pb-24">
    <!-- Header -->
    <div class="mb-10">
        <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">{% if lang == 'uz' %}Profil{% else %}Profile{% endif %}</h1>
        <p class="text-gray-400">{% if lang == 'uz' %}Hisobingiz va test tarixingizni boshqaring{% else %}Manage your account and view test history{% endif %}</p>
    </div>

    <!-- Profile Card -->
    <div class="profile-card rounded-2xl p-6 md:p-8 mb-8">
        <div class="flex flex-col md:flex-row md:items-center gap-6">
            <!-- Avatar -->
            <div class="flex-shrink-0">
                {% if user.avatar %}
                <img src="{{ user.avatar }}" alt="" class="w-20 h-20 md:w-24 md:h-24 rounded-2xl border-2 border-[#00D4AA] shadow-lg shadow-[#00D4AA]/20">
                {% else %}
                <div class="w-20 h-20 md:w-24 md:h-24 rounded-2xl bg-gradient-to-br from-[#00D4AA] to-[#00B894] text-[#0B1628] flex items-center justify-center text-3xl font-bold shadow-lg shadow-[#00D4AA]/20">
                    {{ (user.name or user.email)[0]|upper }}
                </div>
                {% endif %}
            </div>

            <!-- Info -->
            <div class="flex-1">
                <h2 class="text-xl md:text-2xl font-bold text-white mb-1">{{ user.name or user.email }}</h2>
                <p class="text-gray-400 mb-3">{{ user.email }}</p>
                <div class="flex flex-wrap items-center gap-3">
                    {% if user.google_id %}
                    <span class="inline-flex items-center gap-2 bg-gray-800 text-gray-300 text-sm px-3 py-1 rounded-full">
                        <svg class="w-4 h-4" viewBox="0 0 24 24"><path fill="currentColor" d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.701-6.033-6.032s2.701-6.032,6.033-6.032c1.498,0,2.866,0.549,3.921,1.453l2.814-2.814C17.503,2.988,15.139,2,12.545,2C7.021,2,2.543,6.477,2.543,12s4.478,10,10.002,10c8.396,0,10.249-7.85,9.426-11.748L12.545,10.239z"/></svg>
                        Google
                    </span>
                    {% endif %}
                    <span class="text-gray-500 text-sm">
                        {% if lang == 'uz' %}Ro'yxatdan o'tgan: {% else %}Joined: {% endif %}
                        {{ user.created_at[:10] if user.created_at else '—' }}
                    </span>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-card rounded-xl p-4 md:p-6 text-center min-w-[140px]">
                <div class="text-3xl md:text-4xl font-bold text-[#00D4AA] mb-1">
                    {{ (user.free_tests or 0) + (user.purchased_tests or 0) }}
                </div>
                <div class="text-gray-400 text-sm">{% if lang == 'uz' %}Mavjud testlar{% else %}Available Tests{% endif %}</div>
            </div>
        </div>
    </div>

    <!-- Test History -->
    <section class="mb-10">
        <div class="section-header rounded-t-2xl px-6 py-4 border-b border-gray-700">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-[#00D4AA]/10 rounded-xl flex items-center justify-center">
                    <svg class="w-5 h-5 text-[#00D4AA]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                    </svg>
                </div>
                <h2 class="text-xl font-bold text-white">{% if lang == 'uz' %}Test tarixi{% else %}Test History{% endif %}</h2>
            </div>
        </div>

        {% if test_history %}
        <div class="profile-card rounded-b-2xl overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-700 bg-gray-800/50">
                            <th class="text-left text-gray-400 text-xs font-semibold uppercase tracking-wider px-6 py-4">{% if lang == 'uz' %}Sana{% else %}Date{% endif %}</th>
                            <th class="text-center text-gray-400 text-xs font-semibold uppercase tracking-wider px-4 py-4">Reading</th>
                            <th class="text-center text-gray-400 text-xs font-semibold uppercase tracking-wider px-4 py-4">Listening</th>
                            <th class="text-center text-gray-400 text-xs font-semibold uppercase tracking-wider px-4 py-4">Writing</th>
                            <th class="text-center text-gray-400 text-xs font-semibold uppercase tracking-wider px-4 py-4">CEFR</th>
                            <th class="text-right text-gray-400 text-xs font-semibold uppercase tracking-wider px-6 py-4">{% if lang == 'uz' %}Natija{% else %}Result{% endif %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for h in test_history %}
                        <tr class="history-row border-b border-gray-800 last:border-0">
                            <td class="px-6 py-4">
                                <span class="text-white font-medium">{{ h.completed_at[:10] if h.completed_at else '—' }}</span>
                            </td>
                            <td class="text-center px-4 py-4">
                                <span class="inline-flex items-center justify-center bg-gray-800 text-white text-sm font-medium px-3 py-1 rounded-full min-w-[60px]">
                                    {{ h.reading_score or 0 }}/{{ h.reading_total or 0 }}
                                </span>
                            </td>
                            <td class="text-center px-4 py-4">
                                <span class="inline-flex items-center justify-center bg-gray-800 text-white text-sm font-medium px-3 py-1 rounded-full min-w-[60px]">
                                    {{ h.listening_score or 0 }}/{{ h.listening_total or 0 }}
                                </span>
                            </td>
                            <td class="text-center px-4 py-4">
                                <span class="inline-flex items-center justify-center bg-gray-800 text-white text-sm font-medium px-3 py-1 rounded-full min-w-[60px]">
                                    {{ h.writing_percentage or 0 }}%
                                </span>
                            </td>
                            <td class="text-center px-4 py-4">
                                <span class="cefr-badge text-sm font-bold px-3 py-1 rounded-full">{{ h.cefr_level or '—' }}</span>
                            </td>
                            <td class="text-right px-6 py-4">
                                {% if h.session_id %}
                                <a href="/profile/result/{{ h.session_id }}" class="inline-flex items-center gap-2 text-[#00D4AA] hover:text-[#00B894] font-medium text-sm transition">
                                    {% if lang == 'uz' %}Ko'rish{% else %}View{% endif %}
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </a>
                                {% else %}—{% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="profile-card rounded-b-2xl p-8 md:p-12 text-center">
            <div class="w-16 h-16 bg-gray-800 rounded-2xl flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
            </div>
            <h3 class="text-xl font-bold text-white mb-2">{% if lang == 'uz' %}Hali test topshirmagansiz{% else %}No tests yet{% endif %}</h3>
            <p class="text-gray-500 mb-6">{% if lang == 'uz' %}CEFR darajangizni aniqlash uchun testni boshlang{% else %}Start a test to discover your CEFR level{% endif %}</p>
            <a href="/start" class="inline-flex items-center gap-2 bg-[#00D4AA] text-[#0d0d0d] px-6 py-3 font-bold rounded-xl hover:bg-[#00B894] transition">
                {{ t.start_test }}
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                </svg>
            </a>
        </div>
        {% endif %}
    </section>

    <!-- Contact -->
    <section class="mb-10">
        <div class="section-header rounded-t-2xl px-6 py-4 border-b border-gray-700">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-[#00D4AA]/10 rounded-xl flex items-center justify-center">
                    <svg class="w-5 h-5 text-[#00D4AA]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                </div>
                <h2 class="text-xl font-bold text-white">{% if lang == 'uz' %}Biz bilan bog'lanish{% else %}Contact Us{% endif %}</h2>
            </div>
        </div>

        <div class="profile-card rounded-b-2xl p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <a href="mailto:{{ contact.email }}" class="contact-card rounded-xl p-4 flex items-center gap-4">
                    <div class="w-12 h-12 bg-[#00D4AA]/10 rounded-xl flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 text-[#00D4AA]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    <div>
                        <div class="text-gray-500 text-xs uppercase tracking-wider mb-1">Email</div>
                        <div class="text-white font-medium text-sm">{{ contact.email }}</div>
                    </div>
                </a>

                <a href="https://t.me/{{ contact.telegram|replace('@','') }}" target="_blank" rel="noopener" class="contact-card rounded-xl p-4 flex items-center gap-4">
                    <div class="w-12 h-12 bg-[#00D4AA]/10 rounded-xl flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 text-[#00D4AA]" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                        </svg>
                    </div>
                    <div>
                        <div class="text-gray-500 text-xs uppercase tracking-wider mb-1">Telegram</div>
                        <div class="text-white font-medium text-sm">{{ contact.telegram }}</div>
                    </div>
                </a>

                <div class="contact-card rounded-xl p-4 flex items-center gap-4">
                    <div class="w-12 h-12 bg-[#00D4AA]/10 rounded-xl flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 text-[#00D4AA]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                        </svg>
                    </div>
                    <div>
                        <div class="text-gray-500 text-xs uppercase tracking-wider mb-1">{% if lang == 'uz' %}Telefon{% else %}Phone{% endif %}</div>
                        <div class="text-white font-medium text-sm">{{ contact.phone }}</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Feedback -->
    <section class="mb-10">
        <div class="section-header rounded-t-2xl px-6 py-4 border-b border-gray-700">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-[#00D4AA]/10 rounded-xl flex items-center justify-center">
                    <svg class="w-5 h-5 text-[#00D4AA]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                    </svg>
                </div>
                <h2 class="text-xl font-bold text-white">{% if lang == 'uz' %}Fikr-mulohaza{% else %}Feedback{% endif %}</h2>
            </div>
        </div>

        <div class="profile-card rounded-b-2xl p-6">
            <form id="profileFeedbackForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-400 text-sm font-medium mb-2">{% if lang == 'uz' %}Baho{% else %}Rating{% endif %}</label>
                        <select name="rating" class="feedback-input w-full px-4 py-3 text-white rounded-xl">
                            <option value="">{% if lang == 'uz' %}Tanlang{% else %}Select{% endif %}</option>
                            <option value="5">5 - {% if lang == 'uz' %}A'lo{% else %}Excellent{% endif %}</option>
                            <option value="4">4 - {% if lang == 'uz' %}Yaxshi{% else %}Good{% endif %}</option>
                            <option value="3">3 - {% if lang == 'uz' %}O'rtacha{% else %}Average{% endif %}</option>
                            <option value="2">2 - {% if lang == 'uz' %}Yomon{% else %}Poor{% endif %}</option>
                            <option value="1">1 - {% if lang == 'uz' %}Juda yomon{% else %}Very Poor{% endif %}</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-gray-400 text-sm font-medium mb-2">{% if lang == 'uz' %}Xabar{% else %}Message{% endif %}</label>
                    <textarea name="message" rows="4" class="feedback-input w-full px-4 py-3 text-white rounded-xl resize-none" placeholder="{% if lang == 'uz' %}Fikringizni yozing...{% else %}Write your feedback...{% endif %}"></textarea>
                </div>
                <button type="submit" class="inline-flex items-center gap-2 bg-[#00D4AA] text-[#0d0d0d] px-6 py-3 font-bold rounded-xl hover:bg-[#00B894] transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                    {% if lang == 'uz' %}Yuborish{% else %}Submit{% endif %}
                </button>
            </form>
            <p id="feedbackStatus" class="mt-4 text-sm hidden"></p>
        </div>
    </section>

    <!-- Actions -->
    <div class="flex flex-col sm:flex-row gap-4">
        <a href="/start" class="inline-flex items-center justify-center gap-2 bg-[#00D4AA] text-[#0d0d0d] px-8 py-4 font-bold rounded-xl hover:bg-[#00B894] transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
            </svg>
            {{ t.start_test }}
        </a>
        <a href="/" class="inline-flex items-center justify-center gap-2 border border-gray-600 text-gray-300 px-8 py-4 font-medium rounded-xl hover:border-[#00D4AA] hover:text-white transition">
            {% if lang == 'uz' %}Bosh sahifa{% else %}Home{% endif %}
        </a>
        <a href="/logout" class="inline-flex items-center justify-center gap-2 border border-red-500/30 text-red-400 px-8 py-4 font-medium rounded-xl hover:bg-red-900/20 hover:border-red-500 transition ml-auto">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
            </svg>
            {% if lang == 'uz' %}Chiqish{% else %}Logout{% endif %}
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('profileFeedbackForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = e.target;
    const btn = form.querySelector('button[type="submit"]');
    const status = document.getElementById('feedbackStatus');
    btn.disabled = true;
    status.classList.add('hidden');
    const formData = new FormData(form);
    try {
        const r = await fetch('/profile/feedback', { method: 'POST', body: formData });
        const data = await r.json();
        status.classList.remove('hidden');
        if (data.success) {
            status.textContent = "{{ 'Fikr yuborildi, rahmat!' if lang == 'uz' else 'Feedback sent, thank you!' }}";
            status.className = 'mt-4 text-sm text-[#00D4AA]';
            form.reset();
        } else {
            status.textContent = "{{ 'Xatolik. Qaytadan urinib ko\\'ring.' if lang == 'uz' else 'Error. Please try again.' }}";
            status.className = 'mt-4 text-sm text-red-400';
        }
    } catch (err) {
        status.classList.remove('hidden');
        status.textContent = "{{ 'Xatolik.' if lang == 'uz' else 'Error.' }}";
        status.className = 'mt-4 text-sm text-red-400';
    }
    btn.disabled = false;
});
</script>
{% endblock %}
