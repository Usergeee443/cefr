<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>{% if lang == 'uz' %}Test natijasi{% else %}Test Result{% endif %} - CEFR Level</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Nunito', sans-serif; }
        body { background: #131F24; }
        .duo-card { background: #1A2C32; border: 2px solid #2B4148; border-radius: 20px; }
        .score-ring { stroke-dasharray: 264; stroke-dashoffset: 264; animation: fillRing 1.5s ease-out forwards; }
        @keyframes fillRing { to { stroke-dashoffset: var(--offset); } }
    </style>
</head>
<body class="min-h-screen text-white">
    <!-- Header -->
    <header class="border-b-2 border-[#2B4148] bg-[#131F24]/95 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <a href="/" class="flex items-center gap-2">
                    <span class="w-9 h-9 bg-[#58CC02] flex items-center justify-center text-white font-black text-xs rounded-xl" style="box-shadow: 0 2px 0 #46A302;">C</span>
                    <span class="font-black text-white">CEFR</span>
                    <span class="font-black" style="color: #58CC02;">Level</span>
                </a>
            </div>
            <a href="/profile" class="text-[#58CC02] hover:text-white font-bold text-sm">&#8592; {% if lang == 'uz' %}Profil{% else %}Profile{% endif %}</a>
        </div>
    </header>

    <main class="py-6 md:py-10 px-4 pb-24">
        <div class="max-w-5xl mx-auto">
            <p class="text-[#777] text-sm mb-4 font-medium">{{ record.completed_at[:10] if record.completed_at else '—' }}</p>

            <!-- Overall -->
            <div class="duo-card p-6 md:p-8 mb-6 text-center" style="background: linear-gradient(135deg, #1A2C32 0%, #1E3A42 100%);">
                <div class="text-4xl mb-2">&#127942;</div>
                <p class="text-[#777] text-xs font-bold uppercase tracking-wider mb-3">CEFR</p>
                <div class="inline-block bg-[#131F24] border-2 border-[#58CC02]/40 p-6 md:p-8 rounded-3xl mb-4">
                    <div class="text-5xl md:text-7xl font-black text-[#58CC02] mb-1" style="text-shadow: 0 3px 0 #46A302;">{{ session.cefr_level }}</div>
                    <div class="text-sm md:text-lg text-[#AFAFAF] font-bold">{{ session.level_description }}</div>
                </div>
                <div class="text-3xl md:text-4xl font-black text-[#FF9600]">{{ session.overall_score }}%</div>
                <div class="text-xs text-[#777] uppercase tracking-widest font-bold mt-1">{% if lang == 'uz' %}Umumiy{% else %}Overall{% endif %}</div>
            </div>

            <!-- Section Scores -->
            <div class="grid grid-cols-3 gap-3 md:gap-5 mb-6">
                <div class="duo-card p-4 md:p-6 text-center">
                    <div class="text-2xl mb-2">&#128214;</div>
                    <h3 class="text-sm md:text-lg font-black text-white mb-1">Reading</h3>
                    <div class="text-xl md:text-3xl font-black text-[#1CB0F6]">{{ session.reading.percentage }}%</div>
                    <div class="text-xs text-[#777] font-bold">{{ session.reading.score }}/{{ session.reading.total }}</div>
                </div>
                <div class="duo-card p-4 md:p-6 text-center">
                    <div class="text-2xl mb-2">&#127911;</div>
                    <h3 class="text-sm md:text-lg font-black text-white mb-1">Listening</h3>
                    <div class="text-xl md:text-3xl font-black text-[#CE82FF]">{{ session.listening.percentage }}%</div>
                    <div class="text-xs text-[#777] font-bold">{{ session.listening.score }}/{{ session.listening.total }}</div>
                </div>
                <div class="duo-card p-4 md:p-6 text-center">
                    <div class="text-2xl mb-2">&#9997;&#65039;</div>
                    <h3 class="text-sm md:text-lg font-black text-white mb-1">Writing</h3>
                    {% if session.writing.evaluation and session.writing.evaluation.get('overall_percentage') is not none %}
                    <div class="text-xl md:text-3xl font-black text-[#58CC02]">{{ session.writing.evaluation.overall_percentage }}%</div>
                    <div class="text-xs text-[#777] font-bold">Band {{ session.writing.evaluation.get('overall_band', '—') }}</div>
                    {% else %}
                    <div class="text-xl md:text-3xl font-black text-[#58CC02]">{{ session.writing.percentage }}%</div>
                    {% endif %}
                </div>
            </div>

            <!-- Reading Details -->
            {% if session.reading.details %}
            <div class="duo-card overflow-hidden mb-6">
                <div class="p-4 md:p-5 border-b-2 border-[#2B4148]">
                    <h2 class="text-base md:text-lg font-black text-white">&#128214; Reading</h2>
                </div>
                <div class="p-3 md:p-5">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-xs md:text-sm">
                            <thead class="text-[#777] border-b-2 border-[#2B4148]">
                                <tr><th class="px-2 py-2 font-bold">P</th><th class="px-2 py-2 font-bold">Q</th><th class="px-2 py-2 font-bold">{% if lang == 'uz' %}Javob{% else %}Ans{% endif %}</th><th class="px-2 py-2 font-bold">{% if lang == 'uz' %}To'g'ri{% else %}Correct{% endif %}</th><th class="px-2 py-2"></th></tr>
                            </thead>
                            <tbody>
                                {% for d in session.reading.details %}
                                <tr class="border-b border-[#2B4148]/50 {% if not d.ok %}bg-[#FF4B4B]/5{% endif %}">
                                    <td class="px-2 py-2 text-[#777] font-bold">{{ d.part }}</td>
                                    <td class="px-2 py-2 text-white font-bold">{{ d.q }}</td>
                                    <td class="px-2 py-2">{% if not d.ok %}<span class="bg-[#FF4B4B]/20 text-[#FF4B4B] px-1 rounded font-bold text-xs">{{ d.ua or '—' }}</span>{% else %}<span class="text-[#58CC02] font-bold">{{ d.ua or '—' }}</span>{% endif %}</td>
                                    <td class="px-2 py-2 text-[#58CC02] font-bold">{{ d.ca }}</td>
                                    <td class="px-2 py-2">{% if d.ok %}<span class="text-[#58CC02]">&#10004;</span>{% else %}<span class="text-[#FF4B4B]">&#10008;</span>{% endif %}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Listening Details -->
            {% if session.listening.details %}
            <div class="duo-card overflow-hidden mb-6">
                <div class="p-4 md:p-5 border-b-2 border-[#2B4148]">
                    <h2 class="text-base md:text-lg font-black text-white">&#127911; Listening</h2>
                </div>
                <div class="p-3 md:p-5">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-xs md:text-sm">
                            <thead class="text-[#777] border-b-2 border-[#2B4148]">
                                <tr><th class="px-2 py-2 font-bold">P</th><th class="px-2 py-2 font-bold">Q</th><th class="px-2 py-2 font-bold">{% if lang == 'uz' %}Javob{% else %}Ans{% endif %}</th><th class="px-2 py-2 font-bold">{% if lang == 'uz' %}To'g'ri{% else %}Correct{% endif %}</th><th class="px-2 py-2"></th></tr>
                            </thead>
                            <tbody>
                                {% for d in session.listening.details %}
                                <tr class="border-b border-[#2B4148]/50 {% if not d.ok %}bg-[#FF4B4B]/5{% endif %}">
                                    <td class="px-2 py-2 text-[#777] font-bold">{{ d.part }}</td>
                                    <td class="px-2 py-2 text-white font-bold">{{ d.q }}</td>
                                    <td class="px-2 py-2">{% if not d.ok %}<span class="bg-[#FF4B4B]/20 text-[#FF4B4B] px-1 rounded font-bold text-xs">{{ d.ua or '—' }}</span>{% else %}<span class="text-[#58CC02] font-bold">{{ d.ua or '—' }}</span>{% endif %}</td>
                                    <td class="px-2 py-2 text-[#58CC02] font-bold">{{ d.ca }}</td>
                                    <td class="px-2 py-2">{% if d.ok %}<span class="text-[#58CC02]">&#10004;</span>{% else %}<span class="text-[#FF4B4B]">&#10008;</span>{% endif %}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Writing -->
            {% if session.writing.evaluation and session.writing.evaluation.get('task1') %}
            <div class="duo-card overflow-hidden mb-6">
                <div class="p-4 md:p-5 border-b-2 border-[#2B4148]">
                    <h2 class="text-base md:text-lg font-black text-white">&#9997;&#65039; Writing</h2>
                </div>
                <div class="p-4 md:p-5 space-y-5">
                    {% if session.writing.evaluation.task1 %}
                    <div class="bg-[#131F24] border-2 border-[#2B4148] rounded-xl p-4">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-black text-white text-sm">Task 1</h3>
                            <span class="px-3 py-1 bg-[#1CB0F6]/15 text-[#1CB0F6] text-xs font-black rounded-lg">Band {{ session.writing.evaluation.task1.get('band', '—') }}</span>
                        </div>
                        <p class="text-[#AFAFAF] text-sm font-medium">{{ session.writing.evaluation.task1.get('feedback', {}).get('overall', '—') }}</p>
                    </div>
                    {% endif %}
                    {% if session.writing.evaluation.task2 %}
                    <div class="bg-[#131F24] border-2 border-[#2B4148] rounded-xl p-4">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-black text-white text-sm">Task 2</h3>
                            <span class="px-3 py-1 bg-[#CE82FF]/15 text-[#CE82FF] text-xs font-black rounded-lg">Band {{ session.writing.evaluation.task2.get('band', '—') }}</span>
                        </div>
                        <p class="text-[#AFAFAF] text-sm font-medium">{{ session.writing.evaluation.task2.get('feedback', {}).get('overall', '—') }}</p>
                    </div>
                    {% endif %}
                    {% if session.writing.evaluation.essay %}
                    <div class="bg-[#131F24] border-2 border-[#2B4148] rounded-xl p-4">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-black text-white text-sm">Essay</h3>
                            <span class="px-3 py-1 bg-[#58CC02]/15 text-[#58CC02] text-xs font-black rounded-lg">Band {{ session.writing.evaluation.essay.get('band', '—') }}</span>
                        </div>
                        <p class="text-[#AFAFAF] text-sm font-medium">{{ session.writing.evaluation.essay.get('feedback', {}).get('overall', '—') }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Back -->
            <div class="text-center pt-4">
                <a href="/profile" class="inline-flex items-center justify-center gap-2 text-white px-8 py-3 font-black rounded-2xl"
                    style="background: #58CC02; box-shadow: 0 4px 0 #46A302;">
                    &#8592; {% if lang == 'uz' %}Profilga{% else %}Profile{% endif %}
                </a>
            </div>
        </div>
    </main>
</body>
</html>
